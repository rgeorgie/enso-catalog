{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">
    {{ player.full_name() }}
    <small class="text-muted">#{{ player.id }}</small>
  </h2>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">‚Üê {{ _('Back') }}</a>
    <a class="btn btn-outline-primary" href="{{ url_for('edit_player', player_id=player.id) }}">‚úèÔ∏è {{ _('Edit') }}</a>
  </div>
</div>

{% if payment_count == 0 %}
<div class="mb-3">
  <span class="badge text-bg-warning text-dark">{{ _('No payments recorded.') }}</span>
</div>
{% endif %}

{% if current_payment %}
<div class="mb-3">
  {% if current_payment.paid %}
    <span class="badge bg-success">
      {{ _('Monthly Due') }}: {{ current_payment.amount or 0 }} EUR ({{ _('Paid') }})
    </span>
  {% else %}
    <span class="badge bg-danger">
      {{ _('Monthly Due') }}: {{ current_payment.amount or 0 }} EUR ({{ _('Unpaid') }})
    </span>
  {% endif %}
</div>
{% endif %}

<div class="row g-3">
  <!-- LEFT COLUMN -->
  <div class="col-12 col-lg-4">

    <!-- PHOTO -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column align-items-center">
        {% if player.photo_filename %}
          <img src="{{ url_for('uploaded_file', filename=player.photo_filename) }}"
               alt="{{ player.full_name() }}" style="max-height:240px;width:auto;">
        {% else %}
          <div class="text-muted text-center"
               style="height:180px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:.5rem;">
            {{ _('No photo uploaded') }}
          </div>
        {% endif %}
        <div class="mt-2">
          <span style="{{ belt_chip_style(player.belt_rank) | safe }}">
            {% set gl = player.grade_level %}
            {% if gl in ['10 kyu','9 kyu','8 kyu','7 kyu','6 kyu','5 kyu','4 kyu','3 kyu','2 kyu','1 kyu'] %}
              {{ _(gl ~ ' ‚Äì ' ~ {
                '10 kyu': 'white belt',
                '9 kyu': 'white with yellow stripe',
                '8 kyu': 'yellow belt',
                '7 kyu': 'orange belt',
                '6 kyu': 'orange belt',
                '5 kyu': 'green belt',
                '4 kyu': 'blue belt',
                '3 kyu': 'blue belt',
                '2 kyu': 'brown belt',
                '1 kyu': 'brown belt',
              }[gl]) }}
            {% elif gl and 'dan' in gl %}
              {{ _(gl ~ ' ‚Äì black belt') }}
            {% else %}
              {{ gl or player.belt_rank }}
            {% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="card">
      <div class="card-header"><strong>{{ _('Quick actions') }}</strong></div>
      <div class="card-body">

        <!-- PRINT DUE FEES -->
        <form class="row g-2 align-items-end" method="get"
              action="{{ url_for('player_due_print', player_id=player.id) }}">
          <div class="col-12">
            <label class="form-label m-0">{{ _('Print Due Fees') }}</label>
          </div>
          <div class="col-7">
            <input class="form-control"
                   type="text"
                   name="month"
                   placeholder="{{ _('YYYY-MM') }}"
                   aria-label="{{ _('YYYY-MM') }} {{ _('month (optional)') }}">
            <div class="form-text">{{ _('Leave empty for current month') }}</div>
          </div>
          <div class="col-5 d-grid">
            <button class="btn btn-outline-primary">üñ®Ô∏è {{ _('Print Due Fees') }}</button>
          </div>
        </form>

        <hr>

        <!-- RECEIPT SHORTCUTS -->

        <hr>

        <!-- PAY DUES MODAL TRIGGER -->
        <div class="d-grid gap-2">

                <button class="btn btn-success pay-due-modal-btn" type="button" data-player-id="{{ player.id }}">{{ _('Pay All Dues') }}</button>
                <!-- Modal -->
                <div class="modal fade" id="payDueModal" tabindex="-1" aria-labelledby="payDueModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form id="payDueForm">
                        <div class="modal-header">
                          <h5 class="modal-title" id="payDueModalLabel">Outstanding Dues</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div id="duesList">
                            <div class="text-center text-muted py-3">Loading...</div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-success">Confirm Payment</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              let currentPayDuePlayerId = null;
              document.querySelectorAll('.pay-due-modal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                  currentPayDuePlayerId = this.getAttribute('data-player-id');
                  const payDueModal = new bootstrap.Modal(document.getElementById('payDueModal'));
                  document.getElementById('duesList').innerHTML = '<div class="text-center text-muted py-3">Loading...</div>';
                  payDueModal.show();
                  fetch(`/admin/players/${currentPayDuePlayerId}/dues_json`)
                    .then(response => response.json())
                    .then(data => {
                      const duesData = data.dues || [];
                      const duesList = document.getElementById('duesList');
                      if (!duesData.length) {
                        duesList.innerHTML = '<div class="text-center text-muted py-3">Nothing to show.</div>';
                        return;
                      }
                      duesList.innerHTML = duesData.map(function(due, idx) {
                        if (due.type === 'owed_sessions' && due.session_list) {
                          return `<div class="mb-2">
                            <div class="fw-bold mb-1">
                              ${due.label} <span class="badge bg-info text-dark ms-2">${due.amount} EUR</span>
                            </div>
                            <div class="ms-4 mt-2" id="sessions_${idx}">
                              ${due.session_list.map((sess, sidx) => `
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" value="${sess.session_id}" id="session_${sess.session_id}" name="session_ids_${idx}" checked>
                                  <label class="form-check-label" for="session_${sess.session_id}">
                                    ${sess.date} <span class="badge bg-secondary ms-2">${sess.session_id}</span>
                                  </label>
                                </div>
                              `).join('')}
                            </div>
                          </div>`;
                        } else {
                          return `<div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="${due.id}" id="due_${due.id}" name="dues">
                            <label class="form-check-label" for="due_${due.id}">
                              ${due.label} <span class="badge bg-info text-dark ms-2">${due.amount} EUR</span>
                            </label>
                          </div>`;
                        }
                      }).join('');
                    });
                });
              });
              document.getElementById('payDueForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (!currentPayDuePlayerId) return;
                var checked = Array.from(document.querySelectorAll('#duesList input[name="dues"]:checked')).map(cb => cb.value);
                var duesToSend = [];
                var checkedSessionCheckboxes = Array.from(document.querySelectorAll('input[name^="session_ids_"]:checked'));
                var sessionIds = checkedSessionCheckboxes.map(cb => cb.value);
                if (sessionIds.length > 0) {
                  duesToSend.push({type: 'owed_sessions', session_ids: sessionIds});
                }
                checked.forEach(function(val) {
                  duesToSend.push(val);
                });
                if (duesToSend.length === 0) return;
                fetch(`/admin/players/${currentPayDuePlayerId}/pay_due_receipt`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ dues: duesToSend })
                })
                .then(response => response.json())
                .then(data => {
                  if (data.redirect) {
                    window.location.href = data.redirect;
                  }
                });
              });
            });
            </script>
        </div>
      </div>
    </div>

    <!-- PER-SESSION SUMMARY -->
    {% if not player.monthly_fee_is_monthly %}
    <div class="card mt-3">
      <div class="card-header"><strong>{{ _('Training sessions') }}</strong></div>
      <div class="card-body">
        <div><strong>{{ _('Sessions paid') }}:</strong> {{ total_sessions_paid }}</div>
        <div><strong>{{ _('Sessions taken') }}:</strong> {{ total_sessions_taken }}</div>

        {% set rem = total_sessions_paid - total_sessions_taken %}
        <div>
          <strong>{{ _('Remaining sessions') }}:</strong>
          {% if rem >= 0 %}
            {{ rem }}
          {% else %}
            <span class="text-danger">{{ _('Overused by') }} {{ -rem }}</span>
          {% endif %}
        </div>

        <div class="mt-2">
          <strong>{{ _('Prepaid amount') }}:</strong> {{ total_prepaid_amount }} EUR
        </div>

        {% if per_session_amount is not none %}
          <div><strong>{{ _('Per-session price') }}:</strong> {{ per_session_amount }} EUR</div>
          <div><strong>{{ _('Cost for sessions taken') }}:</strong> {{ expected_cost }} EUR</div>
          <div><strong>{{ _('Owed (cost - prepaid)') }}:</strong> {{ owed_amount }} EUR</div>
        {% endif %}

        <hr>

        <strong>{{ _('Session receipts') }}</strong>
        <ul class="list-unstyled mt-2">
        {% if sess_records %}
          <ul class="list-unstyled mt-2">
            {% for r in sess_records %}
              <li class="d-flex justify-content-between align-items-center py-1">
                <a href="{{ url_for('receipt_view', rid=r.id) }}" class="text-decoration-none w-100">
                  <div>
                    <strong>{{ r.receipt_no or ('#' ~ r.id) }}</strong>
                    ‚Äî {{ r.paid_at.date() if r.paid_at else '' }}
                    ‚Ä¢ {{ r.sessions_paid }} {{ _('paid') }},
                      {{ r.sessions_taken }} {{ _('taken') }}
                    ‚Ä¢ {{ r.amount }} EUR
                  </div>
                </a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted"><em>{{ _('No per-session receipts found.') }}</em></div>
        {% endif %}
        </ul>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- RIGHT COLUMN -->
  <div class="col-12 col-lg-8">

    <!-- PROFILE -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Profile') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>{{ _('First Name') }}:</strong> {{ player.first_name }}</div>
            <div><strong>{{ _('Last Name') }}:</strong> {{ player.last_name }}</div>
            <div><strong>{{ _('Gender') }}:</strong> {{ _(player.gender) if player.gender else '‚Äî' }}</div>
            <div><strong>{{ _('Birthdate') }}:</strong> {{ player.birthdate or '‚Äî' }}</div>
             <div><strong>{{ _('PN#') }}:</strong> {{ player.pn or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>{{ _('Discipline') }}:</strong>{{ _(player.discipline) if player.discipline else '‚Äî' }}</div>
            <div><strong>{{ _('Weight (kg)') }}:</strong> {{ player.weight_kg or '‚Äî' }}</div>
            <div><strong>{{ _('Height (cm)') }}:</strong> {{ player.height_cm or '‚Äî' }}</div>
            <div><strong>{{ _('Join Date') }}:</strong> {{ player.join_date or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>


    <!-- CONTACTS & PARENTS -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Contacts') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>{{ _('Email') }}:</strong> {{ player.email or '‚Äî' }}</div>
            <div><strong>{{ _('Phone') }}:</strong> {{ player.phone or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>{{ _('Mother Name') }}:</strong> {{ player.mother_name or '‚Äî' }}</div>
            <div><strong>{{ _('Mother Phone') }}:</strong> {{ player.mother_phone or '‚Äî' }}</div>
            <div><strong>{{ _('Father Name') }}:</strong> {{ player.father_name or '‚Äî' }}</div>
            <div><strong>{{ _('Father Phone') }}:</strong> {{ player.father_phone or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HEALTH & INSURANCE -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Health & Insurance') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-4"><strong>{{ _('Examination Date') }}:</strong> {{ player.medical_exam_date or '‚Äî' }}</div>
          <div class="col-sm-4"><strong>{{ _('Expiry Date') }}:</strong> {{ player.medical_expiry_date or '‚Äî' }}</div>
          <div class="col-sm-4"><strong>{{ _('Insurance Expiry Date') }}:</strong> {{ player.insurance_expiry_date or '‚Äî' }}</div>
        </div>
      </div>
    </div>

    <!-- NOTES -->
    {% if player.notes %}
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Notes') }}</strong></div>
      <div class="card-body">
        <div>{{ player.notes }}</div>
      </div>
    </div>
    {% endif %}

    <!-- SPORTDATA PROFILES -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Sportdata Profiles') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-4"><strong>{{ _('WKF Profile URL') }}:</strong> {% if player.sportdata_wkf_url %}<a href="{{ player.sportdata_wkf_url }}" target="_blank">{{ player.sportdata_wkf_url }}</a>{% else %}‚Äî{% endif %}</div>
          <div class="col-sm-4"><strong>{{ _('BNFK Profile URL') }}:</strong> {% if player.sportdata_bnfk_url %}<a href="{{ player.sportdata_bnfk_url }}" target="_blank">{{ player.sportdata_bnfk_url }}</a>{% else %}‚Äî{% endif %}</div>
          <div class="col-sm-4"><strong>{{ _('ENSO Profile URL') }}:</strong> {% if player.sportdata_enso_url %}<a href="{{ player.sportdata_enso_url }}" target="_blank">{{ player.sportdata_enso_url }}</a>{% else %}‚Äî{% endif %}</div>
        </div>
      </div>
    </div>

    <!-- RECENT EVENTS -->
    <div class="card">
      <div class="card-header"><strong>{{ _('Recent Event Registrations') }}</strong></div>
      <div class="card-body">
        {% if regs %}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>{{ _('Event') }}</th>
                <th>{{ _('Dates') }}</th>
                <th>{{ _('Fee (EUR)') }}</th>
                <th>{{ _('Paid') }}</th>
              </tr>
            </thead>
            <tbody>
              {% set medal_counts = {'gold': 0, 'silver': 0, 'bronze': 0} %}
              {% for r in regs %}
                {% for rc in r.reg_categories %}
                  {% if rc.medal %}
                    {% set _ = medal_counts.__setitem__(rc.medal, medal_counts.get(rc.medal, 0) + 1) %}
                  {% endif %}
                {% endfor %}
              <tr data-bs-toggle="collapse" data-bs-target="#reg-details-{{ r.id }}" aria-expanded="false" aria-controls="reg-details-{{ r.id }}" style="cursor:pointer;">
                <td>{{ r.id }}</td>
                <td>{{ r.event.title }}</td>
                <td>{{ r.event.start_date }}</td>
                <td>{{ r.computed_fee() }}</td>
                <td>{{ _('yes') if r.paid else _('no') }}</td>
              </tr>
              <tr class="collapse" id="reg-details-{{ r.id }}">
                <td colspan="7">
                  {% if r.reg_categories %}
                    <div class="ps-3">
                      <strong>{{ _('Categories & Medals') }}:</strong>
                      <ul class="mb-0">
                        {% for rc in r.reg_categories %}
                          <li>
                            {{ rc.category.name if rc.category else '‚Äî' }}
                            {% if rc.medal %}
                              <span class="badge {% if rc.medal == 'gold' %}bg-warning text-dark{% elif rc.medal == 'silver' %}bg-secondary{% elif rc.medal == 'bronze' %}bg-warning" style="color:#cd7f32!important;"{% endif %}">
                                {{ rc.medal|capitalize }}
                              </span>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% else %}
                    <em>{{ _('No categories for this registration.') }}</em>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="fw-bold bg-light">
                <td colspan="3" class="text-end">{{ _('Total medals') }}</td>
                <td colspan="4">
                  <span class="me-3">ü•á {{ medal_counts['gold'] }}</span>
                  <span class="me-3">ü•à {{ medal_counts['silver'] }}</span>
                  <span>ü•â {{ medal_counts['bronze'] }}</span>
                </td>
              </tr>
            </tfoot>
          </table>
        {% else %}
          <em>{{ _('No registrations yet.') }}</em>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}