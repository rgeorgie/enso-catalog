{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">
    {{ player.full_name() }}
    <small class="text-muted">#{{ player.id }}</small>
  </h2>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">‚Üê Back</a>
    <a class="btn btn-outline-primary" href="{{ url_for('edit_player', player_id=player.id) }}">‚úèÔ∏è Edit</a>
  </div>
</div>

<div class="row g-3">
  <!-- Left column: photo & quick actions -->
  <div class="col-12 col-lg-4">
    <!-- Photo -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column align-items-center">
        {% if player.photo_filename %}
          <img src="{{ url_for('uploaded_file', filename=player.photo_filename) }}"
               alt="{{ player.full_name() }}" style="max-height: 240px; width:auto;">
        {% else %}
          <div class="text-muted text-center"
               style="height: 180px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:.5rem;">
            No photo uploaded
          </div>
        {% endif %}
        <div class="mt-2">
          <span style="{{ belt_chip_style(player.belt_rank) }}">{{ player.belt_rank }}</span>
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="card">
      <div class="card-header"><strong>Quick actions</strong></div>
      <div class="card-body">
        <!-- Print due fees -->
        <form class="row g-2 align-items-end" method="get"
              action="{{ url_for('player_due_print', player_id=player.id) }}">
          <div class="col-12">
            <label class="form-label m-0">Print due fees for</label>
          </div>
          <div class="col-7">
            <input class="form-control" type="text" name="month" placeholder="YYYY-MM"
                   aria-label="YYYY-MM month (optional)">
            <div class="form-text">Leave empty for current month</div>
          </div>
          <div class="col-5 d-grid">
            <button class="btn btn-outline-primary" type="submit">üñ®Ô∏è Print Due Fees</button>
          </div>
        </form>
        <hr>

        <!-- New receipt shortcuts -->
        <div class="d-grid gap-2">
          <!-- Training per month -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_month', player_id=player.id) }}">
            ‚ûï New Training Receipt (per month)
          </a>

          <!-- Training per session (default 8 sessions) -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_session', player_id=player.id, sessions_paid=8) }}">
            ‚ûï New Training Receipt (per session)
          </a>

          <!-- Event receipt (generic: admin can type the Reg ID on the form) -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='event') }}">
            ‚ûï New Event Receipt
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Right column: details -->
  <div class="col-12 col-lg-8">
    <!-- Profile -->
    <div class="card mb-3">
      <div class="card-header"><strong>Profile</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>First Name:</strong> {{ player.first_name }}</div>
            <div><strong>Last Name:</strong> {{ player.last_name }}</div>
            <div><strong>Gender:</strong> {{ player.gender or '‚Äî' }}</div>
            <div><strong>Birthdate:</strong> {{ player.birthdate or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>Discipline:</strong> {{ player.discipline }}</div>
            <div><strong>Weight (kg):</strong> {{ player.weight_kg or '‚Äî' }}</div>
            <div><strong>Height (cm):</strong> {{ player.height_cm or '‚Äî' }}</div>
            <div><strong>Join Date:</strong> {{ player.join_date or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts -->
    <div class="card mb-3">
      <div class="card-header"><strong>Contacts</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>Email:</strong> {{ player.email or '‚Äî' }}</div>
            <div><strong>Phone:</strong> {{ player.phone or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>Mother Name:</strong> {{ player.mother_name or '‚Äî' }}</div>
            <div><strong>Mother Phone:</strong> {{ player.mother_phone or '‚Äî' }}</div>
            <div><strong>Father Name:</strong> {{ player.father_name or '‚Äî' }}</div>
            <div><strong>Father Phone:</strong> {{ player.father_phone or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Health & Insurance -->
    <div class="card mb-3">
      <div class="card-header"><strong>Health & Insurance</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-4">
            {% set txt1, color1 = validity_badge(player.medical_expiry_date) %}
            <div><strong>Medical Examination:</strong> {{ player.medical_exam_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color1 }}">{{ txt1 }}</span></div>
          </div>
          <div class="col-sm-4">
            {% set txt2, color2 = validity_badge(player.medical_expiry_date) %}
            <div><strong>Expiry Date:</strong> {{ player.medical_expiry_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color2 }}">{{ txt2 }}</span></div>
          </div>
          <div class="col-sm-4">
            {% set txt3, color3 = validity_badge(player.insurance_expiry_date) %}
            <div><strong>Insurance Expiry Date:</strong> {{ player.insurance_expiry_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color3 }}">{{ txt3 }}</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Event Registrations -->
    <div class="card">
      <div class="card-header"><strong>Recent Event Registrations</strong></div>
      <div class="card-body">
        {% if regs %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Event</th>
                  <th>Dates</th>
                  <th>Categories</th>
                  <th class="text-end">Fee (EUR)</th>
                  <th class="text-center">Paid</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for r in regs %}
                {% set start = r.event.start_date %}
                {% set endd = r.event.end_date or r.event.start_date %}
                {% set fee = r.fee_override if r.fee_override is not none else r.computed_fee() %}
                <tr>
                  <td>{{ r.id }}</td>
                  <td><a href="{{ url_for('event_detail', event_id=r.event_id) }}">{{ r.event.title }}</a></td>
                  <td>{{ start }}{% if endd and endd != start %} ‚Äì {{ endd }}{% endif %}</td>
                  <td>
                    {% if r.reg_categories %}
                      {{ r.reg_categories | map(attribute='category') | select | map(attribute='name') | join(', ') }}
                    {% else %}<em>‚Äî</em>{% endif %}
                  </td>
                  <td class="text-end">{{ fee if fee is not none else '‚Äî' }}</td>
                  <td class="text-center">
                    {% if r.paid %}<span class="badge text-bg-success">yes</span>{% else %}<span class="badge text-bg-secondary">no</span>{% endif %}
                  </td>
                  <td class="text-center">
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                      <form method="post" action="{{ url_for('event_reg_toggle_paid', reg_id=r.id) }}">
                        <button class="btn btn-sm {% if r.paid %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                          Toggle paid
                        </button>
                      </form>
                      <a class="btn btn-sm btn-outline-primary"
                         href="{{ url_for('payment_new', kind='event', reg_id=r.id) }}">
                        New receipt
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted"><em>No registrations yet.</em></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}