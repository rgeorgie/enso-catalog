{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">
    {{ player.full_name() }}
    <small class="text-muted">#{{ player.id }}</small>
  </h2>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">‚Üê Back</a>
    <a class="btn btn-outline-primary" href="{{ url_for('edit_player', player_id=player.id) }}">‚úèÔ∏è Edit</a>
  </div>
</div>

{% if payment_count == 0 %}
<div class="mb-3">
  <span class="badge text-bg-warning text-dark">No payments recorded</span>
</div>
{% endif %}

{% if current_payment %}
  <div class="mb-3">
    {% if current_payment.paid %}
      <span class="badge bg-success">Monthly due: {{ current_payment.amount or 0 }} EUR (paid)</span>
    {% else %}
      <span class="badge bg-danger">Monthly due: {{ current_payment.amount or 0 }} EUR (unpaid)</span>
    {% endif %}
  </div>
{% endif %}

<div class="row g-3">
  <!-- Left column: photo & quick actions -->
  <div class="col-12 col-lg-4">
    <!-- Photo -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column align-items-center">
        {% if player.photo_filename %}
          <img src="{{ url_for('uploaded_file', filename=player.photo_filename) }}"
               alt="{{ player.full_name() }}" style="max-height: 240px; width:auto;">
        {% else %}
          <div class="text-muted text-center"
               style="height: 180px; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border-radius:.5rem;">
            No photo uploaded
          </div>
        {% endif %}
          <div class="mt-2">
          <span style="{{ belt_chip_style(player.belt_rank) }}">{{ player.grade_level or player.belt_rank }}</span>
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="card">
      <div class="card-header"><strong>Quick actions</strong></div>
      <div class="card-body">
        <!-- Print due fees -->
        <form class="row g-2 align-items-end" method="get"
              action="{{ url_for('player_due_print', player_id=player.id) }}">
          <div class="col-12">
            <label class="form-label m-0">Print due fees for</label>
          </div>
          <div class="col-7">
            <input class="form-control" type="text" name="month" placeholder="YYYY-MM"
                   aria-label="YYYY-MM month (optional)">
            <div class="form-text">Leave empty for current month</div>
          </div>
          <div class="col-5 d-grid">
            <button class="btn btn-outline-primary" type="submit">üñ®Ô∏è Print Due Fees</button>
          </div>
        </form>
        <hr>

        <!-- New receipt shortcuts -->
        <div class="d-grid gap-2">
          <!-- Training per month -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_month', player_id=player.id) }}">
            ‚ûï New Training Receipt (per month)
          </a>

          <!-- Training per session (default 8 sessions) -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_session', player_id=player.id, sessions_paid=8) }}">
            ‚ûï New Training Receipt (per session)
          </a>

          <!-- Event receipt (generic: admin can type the Reg ID on the form) -->
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='event') }}">
            ‚ûï New Event Receipt
          </a>
        </div>
        <hr>
        <div class="d-grid gap-2">
          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}" onsubmit="return confirm('Pay monthly dues for this player?');">
            <input type="hidden" name="kind" value="monthly">
            <button class="btn btn-outline-success">Pay Monthly Dues</button>
          </form>
          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}" onsubmit="return confirm('Pay unpaid event fees for this player?');">
            <input type="hidden" name="kind" value="events">
            <button class="btn btn-outline-success">Pay Event Fees</button>
          </form>
          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}" onsubmit="return confirm('Pay outstanding session debts for this player?');">
            <input type="hidden" name="kind" value="debts">
            <button class="btn btn-outline-success">Pay Session Debts</button>
          </form>
          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}" onsubmit="return confirm('Pay all outstanding dues for this player?');">
            <input type="hidden" name="kind" value="all">
            <button class="btn btn-success">Pay All Dues</button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Per-session summary (if player pays per session) -->
    {% if not player.monthly_fee_is_monthly %}
    <div class="card mt-3">
      <div class="card-header"><strong>Training sessions</strong></div>
      <div class="card-body">
        <div><strong>Sessions paid:</strong> {{ total_sessions_paid }}</div>
        <div><strong>Sessions taken:</strong> {{ total_sessions_taken }}</div>
        {% set rem = total_sessions_paid - total_sessions_taken %}
        <div><strong>Remaining sessions:</strong>
          {% if rem >= 0 %}
            {{ rem }}
          {% else %}
            <span class="text-danger">Overused by {{ -rem }}</span>
          {% endif %}
        </div>
        <div class="mt-2"><strong>Prepaid amount:</strong> {{ total_prepaid_amount }} EUR</div>
        {% if per_session_amount is not none %}
          <div><strong>Per-session price:</strong> {{ per_session_amount }} EUR</div>
          <div><strong>Cost for sessions taken:</strong> {{ expected_cost }} EUR</div>
          <div><strong>Owed (cost - prepaid):</strong> {{ owed_amount }} EUR</div>
        {% endif %}

        <hr>
        <div><strong>Session receipts</strong></div>
        {% if sess_records %}
          <ul class="list-unstyled mt-2">
            {% for r in sess_records %}
              <li class="d-flex justify-content-between align-items-center py-1">
                <div>
                  <strong>{{ r.receipt_no or ('#' ~ r.id) }}</strong>
                  &nbsp;‚Äî {{ r.paid_at.date() if r.paid_at else '' }}
                  &nbsp;‚Ä¢ {{ r.sessions_paid }} paid, {{ r.sessions_taken }} taken
                  &nbsp;‚Ä¢ {{ r.amount }} EUR
                </div>
                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('receipt_view', rid=r.id) }}">View</a>
                  {% if session.get('is_admin') %}
                    <form method="post" action="{{ url_for('receipt_tick_session', rid=r.id) }}">
                      <button class="btn btn-sm btn-outline-success" type="submit">Mark session taken</button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted"><em>No per-session receipts found.</em></div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right column: details -->
  <div class="col-12 col-lg-8">
    <!-- Profile -->
    <div class="card mb-3">
      <div class="card-header"><strong>Profile</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>First Name:</strong> {{ player.first_name }}</div>
            <div><strong>Last Name:</strong> {{ player.last_name }}</div>
            <div><strong>Gender:</strong> {{ player.gender or '‚Äî' }}</div>
            <div><strong>Birthdate:</strong> {{ player.birthdate or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>Discipline:</strong> {{ player.discipline }}</div>
            <div><strong>Weight (kg):</strong> {{ player.weight_kg or '‚Äî' }}</div>
            <div><strong>Height (cm):</strong> {{ player.height_cm or '‚Äî' }}</div>
            <div><strong>Join Date:</strong> {{ player.join_date or '‚Äî' }}</div>
            <div><strong>{{ _('Monthly Fee Type') }}:</strong>
              {% if player.monthly_fee_amount is not none %}
                {{ player.monthly_fee_amount }} EUR ({{ _('monthly') if player.monthly_fee_is_monthly else _('per session') }})
              {% else %}
                ‚Äî
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts -->
    <div class="card mb-3">
      <div class="card-header"><strong>Contacts</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>Email:</strong> {{ player.email or '‚Äî' }}</div>
            <div><strong>Phone:</strong> {{ player.phone or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>Mother Name:</strong> {{ player.mother_name or '‚Äî' }}</div>
            <div><strong>Mother Phone:</strong> {{ player.mother_phone or '‚Äî' }}</div>
            <div><strong>Father Name:</strong> {{ player.father_name or '‚Äî' }}</div>
            <div><strong>Father Phone:</strong> {{ player.father_phone or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Health & Insurance -->
    <div class="card mb-3">
      <div class="card-header"><strong>Health & Insurance</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-4">
            {% set txt1, color1 = validity_badge(player.medical_expiry_date) %}
            <div><strong>Medical Examination:</strong> {{ player.medical_exam_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color1 }}">{{ txt1 }}</span></div>
          </div>
          <div class="col-sm-4">
            {% set txt2, color2 = validity_badge(player.medical_expiry_date) %}
            <div><strong>Expiry Date:</strong> {{ player.medical_expiry_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color2 }}">{{ txt2 }}</span></div>
          </div>
          <div class="col-sm-4">
            {% set txt3, color3 = validity_badge(player.insurance_expiry_date) %}
            <div><strong>Insurance Expiry Date:</strong> {{ player.insurance_expiry_date or '‚Äî' }}</div>
            <div><span class="badge text-bg-{{ color3 }}">{{ txt3 }}</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Event Registrations -->
    <div class="card">
      <div class="card-header"><strong>Recent Event Registrations</strong></div>
      <div class="card-body">
        {% if regs %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Event</th>
                  <th>Dates</th>
                  <th>Categories</th>
                  <th class="text-end">Fee (EUR)</th>
                  <th class="text-center">Paid</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for r in regs %}
                {% set start = r.event.start_date %}
                {% set endd = r.event.end_date or r.event.start_date %}
                {% set fee = r.fee_override if r.fee_override is not none else r.computed_fee() %}
                <tr>
                  <td>{{ r.id }}</td>
                  <td><a href="{{ url_for('event_detail', event_id=r.event_id) }}">{{ r.event.title }}</a></td>
                  <td>{{ start }}{% if endd and endd != start %} ‚Äì {{ endd }}{% endif %}</td>
                  <td>
                    {% if r.reg_categories %}
                      {{ r.reg_categories | map(attribute='category') | select | map(attribute='name') | join(', ') }}
                    {% else %}<em>‚Äî</em>{% endif %}
                  </td>
                  <td class="text-end">{{ fee if fee is not none else '‚Äî' }}</td>
                  <td class="text-center">
                    {% if r.paid %}<span class="badge text-bg-success">yes</span>{% else %}<span class="badge text-bg-secondary">no</span>{% endif %}
                  </td>
                  <td class="text-center">
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                      <form method="post" action="{{ url_for('event_reg_toggle_paid', reg_id=r.id) }}">
                        <button class="btn btn-sm {% if r.paid %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                          Toggle paid
                        </button>
                      </form>
                      <a class="btn btn-sm btn-outline-primary"
                         href="{{ url_for('payment_new', kind='event', reg_id=r.id) }}">
                        New receipt
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted"><em>No registrations yet.</em></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}