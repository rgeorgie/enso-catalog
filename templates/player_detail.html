{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">
    {{ player.full_name() }}
    <small class="text-muted">#{{ player.id }}</small>
  </h2>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">‚Üê {{ _('Back') }}</a>
    <a class="btn btn-outline-primary" href="{{ url_for('edit_player', player_id=player.id) }}">‚úèÔ∏è {{ _('Edit') }}</a>
  </div>
</div>

{% if payment_count == 0 %}
<div class="mb-3">
  <span class="badge text-bg-warning text-dark">{{ _('No payments recorded.') }}</span>
</div>
{% endif %}

{% if current_payment %}
<div class="mb-3">
  {% if current_payment.paid %}
    <span class="badge bg-success">
      {{ _('Monthly Due') }}: {{ current_payment.amount or 0 }} EUR ({{ _('Paid') }})
    </span>
  {% else %}
    <span class="badge bg-danger">
      {{ _('Monthly Due') }}: {{ current_payment.amount or 0 }} EUR ({{ _('Unpaid') }})
    </span>
  {% endif %}
</div>
{% endif %}

<div class="row g-3">
  <!-- LEFT COLUMN -->
  <div class="col-12 col-lg-4">

    <!-- PHOTO -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-column align-items-center">
        {% if player.photo_filename %}
          <img src="{{ url_for('uploaded_file', filename=player.photo_filename) }}"
               alt="{{ player.full_name() }}" style="max-height:240px;width:auto;">
        {% else %}
          <div class="text-muted text-center"
               style="height:180px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;border-radius:.5rem;">
            {{ _('No photo uploaded') }}
          </div>
        {% endif %}
        <div class="mt-2">
          <span style="{{ belt_chip_style(player.belt_rank) | safe }}">
            {{ player.grade_level or player.belt_rank }}
          </span>
        </div>
      </div>
    </div>

    <!-- QUICK ACTIONS -->
    <div class="card">
      <div class="card-header"><strong>{{ _('Quick actions') }}</strong></div>
      <div class="card-body">

        <!-- PRINT DUE FEES -->
        <form class="row g-2 align-items-end" method="get"
              action="{{ url_for('player_due_print', player_id=player.id) }}">
          <div class="col-12">
            <label class="form-label m-0">{{ _('Print Due Fees') }}</label>
          </div>
          <div class="col-7">
            <input class="form-control"
                   type="text"
                   name="month"
                   placeholder="{{ _('YYYY-MM') }}"
                   aria-label="{{ _('YYYY-MM') }} {{ _('month (optional)') }}">
            <div class="form-text">{{ _('Leave empty for current month') }}</div>
          </div>
          <div class="col-5 d-grid">
            <button class="btn btn-outline-primary">üñ®Ô∏è {{ _('Print Due Fees') }}</button>
          </div>
        </form>

        <hr>

        <!-- RECEIPT SHORTCUTS -->
        <div class="d-grid gap-2">
          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_month', player_id=player.id) }}">
            ‚ûï {{ _('New Training Receipt (per month)') }}
          </a>

          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='training_session', player_id=player.id, sessions=5) }}">
            ‚ûï {{ _('New Training Receipt (per session)') }}
          </a>

          <a class="btn btn-outline-primary"
             href="{{ url_for('payment_new', kind='event') }}">
            ‚ûï {{ _('New Event Receipt') }}
          </a>
        </div>

        <hr>

        <!-- PAY DUES -->
        <div class="d-grid gap-2">
          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}">
            <input type="hidden" name="kind" value="monthly">
            <button class="btn btn-outline-success">{{ _('Pay Monthly Dues') }}</button>
          </form>

          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}">
            <input type="hidden" name="kind" value="events">
            <button class="btn btn-outline-success">{{ _('Pay Event Fees') }}</button>
          </form>

          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}">
            <input type="hidden" name="kind" value="debts">
            <button class="btn btn-outline-success">{{ _('Pay Session Debts') }}</button>
          </form>

          <form method="post" action="{{ url_for('player_pay_due', player_id=player.id) }}">
            <input type="hidden" name="kind" value="all">
            <button class="btn btn-success">{{ _('Pay All Dues') }}</button>
          </form>
        </div>
      </div>
    </div>

    <!-- PER-SESSION SUMMARY -->
    {% if not player.monthly_fee_is_monthly %}
    <div class="card mt-3">
      <div class="card-header"><strong>{{ _('Training sessions') }}</strong></div>
      <div class="card-body">
        <div><strong>{{ _('Sessions paid') }}:</strong> {{ total_sessions_paid }}</div>
        <div><strong>{{ _('Sessions taken') }}:</strong> {{ total_sessions_taken }}</div>

        {% set rem = total_sessions_paid - total_sessions_taken %}
        <div>
          <strong>{{ _('Remaining sessions') }}:</strong>
          {% if rem >= 0 %}
            {{ rem }}
          {% else %}
            <span class="text-danger">{{ _('Overused by') }} {{ -rem }}</span>
          {% endif %}
        </div>

        <div class="mt-2">
          <strong>{{ _('Prepaid amount') }}:</strong> {{ total_prepaid_amount }} EUR
        </div>

        {% if per_session_amount is not none %}
          <div><strong>{{ _('Per-session price') }}:</strong> {{ per_session_amount }} EUR</div>
          <div><strong>{{ _('Cost for sessions taken') }}:</strong> {{ expected_cost }} EUR</div>
          <div><strong>{{ _('Owed (cost - prepaid)') }}:</strong> {{ owed_amount }} EUR</div>
        {% endif %}

        <hr>

        <strong>{{ _('Session receipts') }}</strong>

        {% if sess_records %}
          <ul class="list-unstyled mt-2">
            {% for r in sess_records %}
              <li class="d-flex justify-content-between align-items-center py-1">
                <div>
                  <strong>{{ r.receipt_no or ('#' ~ r.id) }}</strong>
                  ‚Äî {{ r.paid_at.date() if r.paid_at else '' }}
                  ‚Ä¢ {{ r.sessions_paid }} {{ _('paid') }},
                    {{ r.sessions_taken }} {{ _('taken') }}
                  ‚Ä¢ {{ r.amount }} EUR
                </div>
                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-primary"
                     href="{{ url_for('receipt_view', rid=r.id) }}">{{ _('View') }}</a>

                  {% if session.get('is_admin') %}
                    <form method="post"
                          action="{{ url_for('receipt_tick_session', rid=r.id) }}">
                      <button class="btn btn-sm btn-outline-success">
                        {{ _('Mark session taken') }}
                      </button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted"><em>{{ _('No per-session receipts found.') }}</em></div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- RIGHT COLUMN -->
  <div class="col-12 col-lg-8">

    <!-- PROFILE -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Profile') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>{{ _('First Name') }}:</strong> {{ player.first_name }}</div>
            <div><strong>{{ _('Last Name') }}:</strong> {{ player.last_name }}</div>
            <div><strong>{{ _('Gender') }}:</strong> {{ _(player.gender) if player.gender else '‚Äî' }}</div>
            <div><strong>{{ _('Birthdate') }}:</strong> {{ player.birthdate or '‚Äî' }}</div>
          </div>
          <div class="col-sm-6">
            <div><strong>{{ _('Discipline') }}:</strong>{{ _(player.discipline) if player.discipline else '‚Äî' }}</div>
            <div><strong>{{ _('Weight (kg)') }}:</strong> {{ player.weight_kg or '‚Äî' }}</div>
            <div><strong>{{ _('Height (cm)') }}:</strong> {{ player.height_cm or '‚Äî' }}</div>
            <div><strong>{{ _('Join Date') }}:</strong> {{ player.join_date or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTACTS -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Contacts') }}</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-sm-6">
            <div><strong>{{ _('Email') }}:</strong> {{ player.email or '‚Äî' }}</div>
            <div><strong>{{ _('Phone') }}:</strong> {{ player.phone or '‚Äî' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HEALTH & INSURANCE -->
    <div class="card mb-3">
      <div class="card-header"><strong>{{ _('Health & Insurance') }}</strong></div>
      <div class="card-body">
        <!-- unchanged validity logic -->
      </div>
    </div>

    <!-- RECENT EVENTS -->
    <div class="card">
      <div class="card-header"><strong>{{ _('Recent Event Registrations') }}</strong></div>
      <div class="card-body">
        {% if regs %}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>{{ _('Event') }}</th>
                <th>{{ _('Dates') }}</th>
                <th>{{ _('Categories') }}</th>
                <th>{{ _('Fee (EUR)') }}</th>
                <th>{{ _('Paid') }}</th>
                <th>{{ _('Actions') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for r in regs %}
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.event.title }}</td>
                <td>{{ r.event.start_date }}</td>
                <td>{{ r.reg_categories | map(attribute='category.name') | join(', ') }}</td>
                <td>{{ r.computed_fee() }}</td>
                <td>{{ _('yes') if r.paid else _('no') }}</td>
                <td>
                  <a class="btn btn-sm btn-outline-primary"
                     href="{{ url_for('payment_new', kind='event', reg_id=r.id) }}">
                    {{ _('New receipt') }}
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <em>{{ _('No registrations yet.') }}</em>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}