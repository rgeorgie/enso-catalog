{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">{{ _('Fees Report') }}  – {{ year }}-{{ "%02d"|format(month) }}</h2>

  <form method="get" class="d-flex align-items-center gap-2" id="monthForm">
    <label class="form-label m-0" for="month">{{ _('Month') }}</label>
    <input type="month" id="month" name="month" class="form-control" style="width: 160px"
           value="{{ '%04d-%02d'|format(year, month) }}">
    <button class="btn btn-primary">{{ _('Open') }}</button>
    <a class="btn btn-outline-secondary"
       href="{{ url_for('fees_export_csv', month='%04d-%02d'|format(year, month)) }}">
      {{ _('Export CSV') }}
    </a>
  </form>
  <a class="btn btn-secondary ms-2" href="{{ request.referrer or url_for('list_players') }}">{{ _('Back') }}</a>
</div>

<p class="text-muted mb-3">{{ _('Due date') }}: <strong>{{ due_date }}</strong></p>

{% if payments %}
  <div class="table-responsive">
    <table class="table table-sm align-middle" id="feesTable">
      <thead>
        <tr>
          <th>#</th>
          <th>{{ _('Player') }}</th>
          <th class="text-end">{{ _('Monthly') }}</th>
          <th class="text-end">{{ _('Session') }}</th>
          <th class="text-end">{{ _('Event') }}</th>
          <th class="text-end">{{ _('Category Fees') }}</th>
          <th class="text-center">{{ _('Paid') }}</th>
          <th class="text-end">{{ _('Owed') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for p in payments %}
        <tr class="details-toggle"
          data-player-id="{{ p.player_id }}"
          data-monthly-amount="{{ p.monthly_amount or '' }}"
          data-monthly-paid="{{ '1' if p.monthly_paid else '0' }}"
          data-monthly-id="{{ p.monthly_id or '' }}"
          data-monthly-receipt-no="{{ p.monthly_receipt_no or '' }}"
          data-monthly-receipt-id="{{ p.monthly_receipt_id or '' }}"
          data-session-prepaid="{{ p.prepaid_amount or '' }}"
          data-session-owed="{{ p.owed_amount or '' }}"
          data-session-receipt-no="{{ p.session_receipt_no or '' }}"
          data-session-receipt-id="{{ p.session_receipt_id or '' }}"
          data-year="{{ p.year }}"
          data-month="{{ '%02d'|format(p.month) }}"
          data-events='{{ (p.event_details | default([], true) | tojson) | safe }}'>
          <td>{{ p.player_id }}</td>
          <td>
            {{ p.player.full_name() }}
          </td>
          <td class="text-end">{% if p.monthly_amount %}{{ p.monthly_amount }}{% else %}—{% endif %}</td>
          <td class="text-end">{% if p.prepaid_amount %}{{ p.prepaid_amount }}{% else %}—{% endif %}</td>
          <td class="text-end">{% if p.event_total %}{{ p.event_total }}{% else %}—{% endif %}</td>
          <td class="text-end">{% if p.category_fees %}{{ p.category_fees }}{% else %}—{% endif %}</td>
          <td class="text-center">
            {% if p.monthly_paid or p.event_total %}
              <span class="badge text-bg-success">{{ _('Yes') }}</span>
            {% else %}
              <span class="badge text-bg-secondary">{{ _('No') }}</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if p.owed_amount is not none and p.owed_amount|float >= 0 %}
              <span class="badge {{ 'bg-danger' if p.owed_amount > 0 else 'bg-success' }}">{{ p.owed_amount }}</span>
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        {% set ns = namespace(total_monthly=0, total_session=0, total_event=0, total_category=0, total_owed=0) %}
        {% for p in payments %}
          {% if p.monthly_amount %}{% set ns.total_monthly = ns.total_monthly + p.monthly_amount %}{% endif %}
          {% if p.prepaid_amount %}{% set ns.total_session = ns.total_session + p.prepaid_amount %}{% endif %}
          {% if p.event_total %}{% set ns.total_event = ns.total_event + p.event_total %}{% endif %}
          {% if p.category_fees %}{% set ns.total_category = ns.total_category + p.category_fees %}{% endif %}
          {% if p.owed_amount is not none %}{% set ns.total_owed = ns.total_owed + p.owed_amount %}{% endif %}
        {% endfor %}
        <tr class="fw-bold bg-light">
          <td colspan="2" class="text-end">{{ _('Totals') }}</td>
          <td class="text-end" id="totalMonthly">{{ ns.total_monthly }}</td>
          <td class="text-end" id="totalSession">{{ ns.total_session }}</td>
          <td class="text-end" id="totalEvent">{{ ns.total_event }}</td>
          <td class="text-end" id="totalCategory">{{ ns.total_category }}</td>
          <td></td>
          <td class="text-end" id="totalOwed">{{ ns.total_owed }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <div class="alert alert-info">{{ _('Nothing to show.') }}</div>
{% endif %}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function() {
  // Compute a safe base URL for receipts. We call url_for with an integer,
  // then strip the trailing "0" so we can append any numeric rid in JS.
  const receiptViewBase = "{{ url_for('receipt_view', rid=0) }}".replace(/0$/, "");

  // DataTables init
  var table = $('#feesTable').DataTable({
    paging: false,
    info: false,
    searching: true,
    ordering: true,
    order: [[0, 'asc']],
    columnDefs: [
      { targets: [0], orderable: true },
      { targets: [1,2,3,4,5,6,7], orderable: false }
    ]
  });

  // Toggle child row
  $('#feesTable tbody').on('click', 'tr.details-toggle', function () {
    var row = table.row(this);
    if (row.child.isShown()) {
      row.child.hide();
      $(this).removeClass('shown');
    } else {
      var html = buildDetailsHtml(this);
      row.child(html).show();
      $(this).addClass('shown');
    }
  });

    function buildDetailsHtml(tr) {
      var $tr = $(tr);
      var playerId = $tr.data('player-id');
      var monthlyAmount = $tr.data('monthly-amount') || '—';
      var monthlyPaid = String($tr.data('monthly-paid')) === '1';
      var monthlyId = $tr.data('monthly-id') || '';
      var monthlyReceiptNo = $tr.data('monthly-receipt-no') || '';
      var monthlyReceiptId = $tr.data('monthly-receipt-id') || '';
      var sessionPrepaid = $tr.data('session-prepaid') || '—';
      var sessionOwed = $tr.data('session-owed') || '—';
      var sessionReceiptNo = $tr.data('session-receipt-no') || '';
      var sessionReceiptId = $tr.data('session-receipt-id') || '';
      var year = $tr.data('year');
      var month = $tr.data('month');
      var events = [];
      try {
        events = JSON.parse($tr.attr('data-events') || '[]');
      } catch(e) { events = []; }

      var monthlyBadge = monthlyPaid
        ? '<span class="badge text-bg-success">{{ _("Paid") }}</span>'
        : '<span class="badge text-bg-secondary">{{ _("Unpaid") }}</span>';

      // Monthly receipt link
      var monthlyReceiptHtml = '';
      if (monthlyReceiptNo && monthlyReceiptId) {
        monthlyReceiptHtml = `<a href="${receiptViewBase}${monthlyReceiptId}" target="_blank">${monthlyReceiptNo}</a>`;
      }

      // Session receipt link
      var sessionReceiptHtml = '';
      if (sessionReceiptNo && sessionReceiptId) {
        sessionReceiptHtml = `<a href="${receiptViewBase}${sessionReceiptId}" target="_blank">${sessionReceiptNo}</a>`;
      }

      // Events list with safe receipt links
      var eventsHtml = '—';
      if (Array.isArray(events) && events.length) {
        eventsHtml = '<ul class="mb-0">';
        events.forEach(function(ev) {
          var name = (ev.event_name || '—');
          var amount = (ev.amount != null ? ev.amount : '—');
          var rid = ev.id;
          var receiptNo = ev.receipt_no || '';
          var viewLink = (rid != null && /^[0-9]+$/.test(String(rid)))
            ? `<a href="${receiptViewBase}${rid}" target="_blank">${receiptNo ? receiptNo : '{{ _('View receipt') }}'}</a>`
            : '';
          eventsHtml += `<li>${name}: ${amount} EUR${ viewLink ? ', ' + viewLink : ''}</li>`;
        });
        eventsHtml += '</ul>';
      }

      return `
        <div class="p-2">
          <div class="mb-1">
            <strong>{{ _('Monthly') }}:</strong> ${monthlyAmount} ${monthlyBadge}
            ${monthlyReceiptHtml ? ' | ' + monthlyReceiptHtml : ''}
          </div>
          <div class="mb-1">
            <strong>{{ _('Session') }}:</strong> ${sessionPrepaid} ({{ _('Paid') }})
            ${sessionReceiptHtml ? ' | ' + sessionReceiptHtml : ''},
            ${sessionOwed} ({{ _('Owed') }})
          </div>
          <div class="mb-1">
            <strong>{{ _('Events') }}:</strong> ${eventsHtml}
          </div>
        </div>
      `;
    }

  // Month picker auto-submit
  $('#month').on('change', function() {
    $('#monthForm').submit();
  });
});
</script>
{% endblock %}