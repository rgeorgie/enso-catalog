{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">{{ _('Sports Calendar') }}</h1>
  <div class="d-flex gap-2 align-items-center">
    <div class="btn-group" role="group">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('events_calendar', month=prev_str) }}">← {{ _('Previous') }}</a>
      <span class="btn btn-outline-secondary btn-sm disabled">{{ month_name }} {{ year }}</span>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('events_calendar', month=next_str) }}">{{ _('Next') }} →</a>
    </div>
    {% if session.get('is_admin') %}
      <a class="btn btn-primary" href="{{ url_for('event_new') }}">{{ _('New Event') }}</a>
      <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importEventZipModal">{{ _('Import Event (ZIP)') }}</button>
    {% endif %}
    <a class="btn btn-secondary" href="{{ request.referrer or url_for('list_players') }}">{{ _('Back') }}</a>
  </div>
</div>

{% if session.get('is_admin') %}
<div class="modal fade" id="importEventZipModal" tabindex="-1" aria-labelledby="importEventZipLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="importEventZipForm" method="post" action="{{ url_for('import_event_zip') }}" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="importEventZipLabel">{{ _('Import Event (ZIP)') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{{ _('Upload exported event ZIP') }}</label>
          <input type="file" name="zipfile" accept=".zip" class="form-control" required />
        </div>
        <div class="form-text text-muted">{{ _('This will create the event and its categories. Registrations are imported when matching players exist.') }}</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="submit" class="btn btn-primary">{{ _('Import') }}</button>
      </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <div id="events-calendar"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Use server-provided month/year instead of current date
  let displayDate = new Date({{ year }}, {{ month - 1 }}, 1);

  // Helper function to format date as YYYY-MM-DD in local time
  function formatLocalDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function renderCalendar(date) {
    const year = date.getFullYear();
    const month = date.getMonth();

    // Adjust for Monday-first calendar
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(firstDay.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));

    const calendar = document.getElementById('events-calendar');
    calendar.innerHTML = '';

    // Week header
    const weekDays = ['{{ _("Mon") }}', '{{ _("Tue") }}', '{{ _("Wed") }}', '{{ _("Thu") }}', '{{ _("Fri") }}', '{{ _("Sat") }}', '{{ _("Sun") }}'];
    const weekHeader = document.createElement('div');
    weekHeader.className = 'row mb-2';
    weekDays.forEach(day => {
      const dayCell = document.createElement('div');
      dayCell.className = 'col text-center fw-bold';
      dayCell.textContent = day;
      weekHeader.appendChild(dayCell);
    });
    calendar.appendChild(weekHeader);

    // Calendar grid
    let currentDate = new Date(startDate);
    for (let week = 0; week < 6; week++) {
      const weekRow = document.createElement('div');
      weekRow.className = 'row mb-2';

      for (let day = 0; day < 7; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'col';

        const dayButton = document.createElement('button');
        dayButton.className = 'btn w-100 position-relative';
        dayButton.style.minHeight = '80px';

        // Check if this is today's date (only highlight if shown month/year match)
        const today = new Date();
        const isToday = currentDate.getDate() === today.getDate() &&
                       currentDate.getMonth() === today.getMonth() &&
                       currentDate.getFullYear() === today.getFullYear();

        if (isToday && currentDate.getMonth() === month && currentDate.getFullYear() === year) {
          dayButton.classList.add('btn-success');
        } else if (currentDate.getMonth() === month && currentDate.getFullYear() === year) {
          dayButton.classList.add('btn-outline-primary');
        } else {
          dayButton.classList.add('btn-outline-secondary');
          dayButton.disabled = true;
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'fw-bold';
        dayNumber.textContent = currentDate.getDate();
        dayButton.appendChild(dayNumber);

        // Add events for this day
        const dayEvents = {{ events_by_date | tojson }};
        const dateKey = formatLocalDate(currentDate);
        if (dayEvents[dateKey]) {
          dayEvents[dateKey].forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'small text-start mt-1';
            eventDiv.innerHTML = `${event.registrations_count > 0 ? '<img src="' + '{{ app_logo }}' + '" style="height: 12px; width: auto;" class="me-1" alt="ENSO">' : ''}<a href="${event.url}" class="text-decoration-none">${event.title}${event.registrations_count > 0 ? ' (' + event.registrations_count + ')' : ''}</a>`;
            dayButton.appendChild(eventDiv);
          });
        }

        // Add attendance badge if there are sessions
        const attendanceData = {{ attendance_by_date | tojson }};
        if (attendanceData[dateKey] && attendanceData[dateKey] > 0) {
          const badge = document.createElement('span');
          badge.className = 'badge bg-success position-absolute top-0 end-0';
          badge.style.whiteSpace = 'pre-line';
          badge.style.fontSize = '0.7em';
          badge.style.lineHeight = '1.1';
          const lang = '{{ current_lang }}';
          let label = '{{ _("Athletes participated:") }}';
          if (lang === 'bg') {
            label = 'Участвали\nспортисти:';
          }
          badge.textContent = label + ' ' + attendanceData[dateKey];
          dayButton.appendChild(badge);
        }

        dayCell.appendChild(dayButton);
        weekRow.appendChild(dayCell);

        currentDate.setDate(currentDate.getDate() + 1);
      }

      calendar.appendChild(weekRow);
    }
  }

  renderCalendar(displayDate);
});
</script>
{% endblock %}