{% extends 'base.html' %}

{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2 mt-3">
    <h1>{{ _('Admin imports') }}</h1>
    <p class="text-muted">{{ _('Quick links to import data into the system.') }}</p>

    <div class="row g-3">
      <div class="col-12 col-md-6">
        <div class="card p-3">
          <h5>{{ _('Import Players (ZIP)') }}</h5>
          <form id="importPlayersZipForm" enctype="multipart/form-data">
            <div class="mb-2">
              <input type="file" name="zipfile" accept=".zip" required class="form-control">
            </div>
            <button class="btn btn-primary" id="importPlayersZipBtn" type="button">{{ _('Import Players (ZIP)') }}</button>
          </form>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="card p-3">
          <h5>{{ _('Import Players (CSV)') }}</h5>
          <form id="importPlayersCsvForm" enctype="multipart/form-data">
            <div class="mb-2">
              <input type="file" name="csv_file" accept=".csv" required class="form-control">
            </div>
            <button class="btn btn-primary" id="importPlayersCsvBtn" type="button">{{ _('Import Players (CSV)') }}</button>
          </form>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="card p-3">
          <h5>{{ _('Import Event (ZIP)') }}</h5>
          <form id="importEventZipForm" enctype="multipart/form-data">
            <div class="mb-2">
              <input type="file" name="zipfile" accept=".zip" required class="form-control">
            </div>
            <button class="btn btn-primary" id="importEventZipBtn" type="button">{{ _('Import Event (ZIP)') }}</button>
          </form>
        </div>
      </div>

      <div class="col-12 col-md-6">
        <div class="card p-3">
          <h5>{{ _('Import Payments (CSV)') }}</h5>
          <form id="importPaymentsCsvForm" enctype="multipart/form-data">
            <div class="mb-2">
              <input type="file" name="csv_file" accept=".csv" required class="form-control">
            </div>
            <div class="form-text small text-muted mb-2">{{ _('Expected headers: player_pn OR player_id, kind, year, month, amount, currency, paid, paid_at, receipt_no, payment_id, event_registration_id, sessions_paid, sessions_taken, note, method') }}</div>
            <button class="btn btn-primary" id="importPaymentsCsvBtn" type="button">{{ _('Import Payments (CSV)') }}</button>
          </form>
        </div>
      </div>
    </div>

    <hr />
    <p class="small text-muted mt-3">{{ _('CSV uploads require admin privileges. ZIP import dialogs are available on the players and events pages.') }}</p>
    
    <div class="mt-4">
      <a class="btn btn-secondary" href="{{ request.referrer or url_for('list_players') }}">{{ _('Back') }}</a>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{{ _('Loading...') }}</span>
        </div>
        <p class="mt-2">{{ _('Processing import... Please wait.') }}</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle import buttons with AJAX
  const buttons = [
    { btn: 'importPlayersZipBtn', form: 'importPlayersZipForm', url: '{{ url_for("import_players_zip") }}' },
    { btn: 'importPlayersCsvBtn', form: 'importPlayersCsvForm', url: '{{ url_for("admin_players_import_csv") }}' },
    { btn: 'importEventZipBtn', form: 'importEventZipForm', url: '{{ url_for("import_event_zip") }}' },
    { btn: 'importPaymentsCsvBtn', form: 'importPaymentsCsvForm', url: '{{ url_for("admin_payments_import_csv") }}' }
  ];

  buttons.forEach(({ btn, form, url }) => {
    const button = document.getElementById(btn);
    const formEl = document.getElementById(form);
    if (button && formEl) {
      button.addEventListener('click', function() {
        const fileInput = formEl.querySelector('input[type="file"]');
        if (!fileInput || !fileInput.files[0]) {
          alert('{{ _("Please select a file first.") }}');
          return;
        }

        // Show loading modal
        const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
        modal.show();

        // Prepare form data
        const formData = new FormData(formEl);

        // Send AJAX request
        fetch(url, {
          method: 'POST',
          body: formData
        })
        .then(response => response.text())
        .then(html => {
          // Reload page to show flash messages
          window.location.reload();
        })
        .catch(error => {
          console.error('Import error:', error);
          modal.hide();
          alert('{{ _("Import failed. Please try again.") }}');
        });
      });
    }
  });
});
</script>

{% endblock %}
