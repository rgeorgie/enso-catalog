{% extends "base.html" %}
{% block content %}
<h1 class="mb-3">{{ _('Registrations') }} â€” {{ ev.title }}</h1>

<!-- Bulk add form -->
<form method="post" class="row g-3 mb-4">
  {{ form.csrf_token }}
  <div class="col-md-5">
    <label class="form-label">{{ _('Athlete') }}</label>
    {{ form.player_ids(class="form-select", multiple=True, size=8) }}
    <div class="form-text">
      Hold <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> to select multiple. Each submit creates a <strong>new entry per athlete</strong>.
    </div>
  </div>

  <div class="col-md-4">
    <label class="form-label">{{ _('Select Categories') }}</label>
    {{ form.category_ids(class="form-select", multiple=True, size=8) }}
  </div>

  <div class="col-md-1">
    <label class="form-label">{{ _('Fee Override (EUR)') }}</label>
    {{ form.fee_override(class="form-control", placeholder="e.g., 80") }}
  </div>

  <div class="col-md-2 d-flex align-items-end">
    <div class="w-100">
      <div class="form-check mb-2">
        {{ form.paid(class="form-check-input", id="paid") }}
        <label class="form-check-label" for="paid">{{ _('Paid') }}</label>
      </div>
      <button class="btn btn-primary w-100" type="submit">{{ _('Add Registration') }}</button>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_detail', event_id=ev.id) }}">{{ _('Event') }}</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_categories', event_id=ev.id) }}">{{ _('Categories') }}</a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_export_csv', event_id=ev.id) }}">{{ _('Export Registrations CSV') }}</a>
      </div>
    </div>
  </div>
</form>

<!-- Filters & search -->
<form method="get" class="row g-3 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label">{{ _('Search') }}</label>
    <input type="text" class="form-control" name="q" value="{{ q or '' }}" placeholder="{{ _('Name') }} / {{ _('Categories') }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">{{ _('Paid') }}</label>
    <select name="paid" class="form-select">
      <option value="" {% if not paid_filter %}selected{% endif %}>{{ _('All') }}</option>
      <option value="paid" {% if paid_filter == 'paid' %}selected{% endif %}>{{ _('Paid') }}</option>
      <option value="unpaid" {% if paid_filter == 'unpaid' %}selected{% endif %}>{{ _('No') }}</option>
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-outline-primary w-100" type="submit">{{ _('Apply') }}</button>
  </div>
  <div class="col-md-3">
    <a class="btn btn-outline-secondary w-100" href="{{ url_for('event_registrations', event_id=ev.id) }}">{{ _('Reset') }}</a>
  </div>
</form>

{% if regs %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Categories') }} / {{ _('Medals') }}</th>
          <th class="text-end">{{ _('Amount') }}</th>
          <th class="text-center">{{ _('Paid') }}</th>
          <th class="text-end"></th>
        </tr>
      </thead>
      <tbody>
      {% for r in regs %}
        <tr>
          <td class="text-nowrap">
            <a href="{{ url_for('player_detail', player_id=r.player.id) }}">{{ r.player.full_name() }}</a>
          </td>
          <td>
            {% if r.reg_categories %}
              <div class="d-flex flex-wrap gap-2">
                {% for rc in r.reg_categories %}
                  <div class="d-inline-flex align-items-center gap-2">
                    <span class="badge text-bg-secondary">{{ rc.category.name }}</span>

                    <form method="post" action="{{ url_for('event_reg_set_medal', reg_id=r.id, cat_id=rc.category_id) }}" class="d-inline">
                      <select name="medal" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="" {% if not rc.medal %}selected{% endif %}>{{ _('None') }}</option>
                        <option value="gold" {% if rc.medal=='gold' %}selected{% endif %}>ðŸ¥‡ {{ _('Gold') }}</option>
                        <option value="silver" {% if rc.medal=='silver' %}selected{% endif %}>ðŸ¥ˆ {{ _('Silver') }}</option>
                        <option value="bronze" {% if rc.medal=='bronze' %}selected{% endif %}>ðŸ¥‰ {{ _('Bronze') }}</option>
                      </select>
                    </form>

                    <form method="post" action="{{ url_for('event_reg_remove_category', reg_id=r.id, cat_id=rc.category_id) }}" class="d-inline">
                      <button class="btn btn-sm btn-outline-danger" type="submit" title="{{ _('Remove') }}">Ã—</button>
                    </form>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="text-end">
            {% set computed = 0 %}
            {% set has_any = false %}
            {% for rc in r.reg_categories %}
              {% if rc.category and rc.category.fee is not none %}
                {% set computed = computed + rc.category.fee %}
                {% set has_any = true %}
              {% endif %}
            {% endfor %}
            {% if r.fee_override is not none %}
              {{ r.fee_override }} â‚¬ <span class="text-muted small">({{ _('override') }})</span>
              {% if has_any %}
                <span class="text-muted">/</span>
                {{ computed }} â‚¬ <span class="text-muted small">({{ _('computed') }})</span>
              {% endif %}
            {% elif has_any %}
              {{ computed }} â‚¬ <span class="text-muted small">({{ _('computed') }})</span>
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="text-center">
            {% if r.paid %}
              <span class="badge bg-success">{{ _('Yes') }}</span>
              {% if r.paid_on %}<div class="small text-muted">{{ r.paid_on }}</div>{% endif %}
            {% else %}
              <span class="badge bg-danger">{{ _('No') }}</span>
            {% endif %}
          </td>
          <td class="text-end">
            <form method="post" action="{{ url_for('event_reg_toggle_paid', reg_id=r.id) }}" class="d-inline">
              <button class="btn btn-sm {% if r.paid %}btn-outline-secondary{% else %}btn-outline-success{% endif %}" type="submit">
                {{ _('Toggle Paid') }}
              </button>
            </form>
            <form method="post" action="{{ url_for('event_reg_delete', reg_id=r.id) }}" class="d-inline ms-1">
              <button class="btn btn-sm btn-outline-danger" type="submit">{{ _('Delete') }}</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>

      <tfoot class="table-light">
        <tr>
          <th colspan="2" class="text-end">{{ _('Participants') }}:</th>
          <th colspan="3">{{ unique_participants }}</th>
        </tr>
        <tr>
          <th colspan="2" class="text-end">{{ _('Entries') }}:</th>
          <th colspan="3">{{ entries_count }}</th>
        </tr>
        <tr>
          <th colspan="2" class="text-end">{{ _('Total expected') }}:</th>
          <th colspan="3">{{ total_expected }} â‚¬</th>
        </tr>
        <tr>
          <th colspan="2" class="text-end">{{ _('Total paid') }}:</th>
          <th colspan="3">{{ total_paid }} â‚¬</th>
        </tr>
        <tr>
          <th colspan="2" class="text-end">{{ _('Total unpaid') }}:</th>
          <th colspan="3">{{ total_unpaid }} â‚¬</th>
        </tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <div class="alert alert-info">{{ _('No registrations yet.') }}</div>
{% endif %}
{% endblock %}