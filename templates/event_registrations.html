{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h2 class="m-0">{{ _('Registrations') }} â€“ {{ ev.title }}</h2>

  <form method="get" class="d-flex align-items-center gap-2">
    <label class="form-label m-0" for="paid">{{ _('Paid') }}</label>
    <select id="paid" name="paid" class="form-select" style="width: 140px">
      <option value=""  {% if paid_filter=="" %}selected{% endif %}>{{ _('All') }}</option>
      <option value="paid" {% if paid_filter=="paid" %}selected{% endif %}>{{ _('Paid') }}</option>
      <option value="unpaid" {% if paid_filter=="unpaid" %}selected{% endif %}>{{ _('Unpaid') }}</option>
    </select>

    <input type="text" name="q" class="form-control" style="width: 220px"
           placeholder="{{ _('Search name / category') }}" value="{{ q or '' }}">
    <button class="btn btn-primary">{{ _('Apply') }}</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('event_detail', event_id=ev.id) }}">{{ _('Back') }}</a>
  </form>
</div>

<div class="row g-2 mb-3">
  <div class="col-auto"><span class="badge text-bg-secondary">{{ _('Participants') }}: {{ unique_participants }}</span></div>
  <div class="col-auto"><span class="badge text-bg-secondary">{{ _('Entries') }}: {{ entries_count }}</span></div>
  <div class="col-auto"><span class="badge text-bg-secondary">{{ _('Total expected') }}: {{ total_expected }}</span></div>
  <div class="col-auto"><span class="badge text-bg-secondary">{{ _('Total paid') }}: {{ total_paid }}</span></div>
  <div class="col-auto"><span class="badge text-bg-secondary">{{ _('Total unpaid') }}: {{ total_unpaid }}</span></div>
</div>

<div class="table-responsive">
  <table class="table table-sm align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>{{ _('Player') }}</th>
        <th>{{ _('Categories') }}</th>
        <th>{{ _('Medals') }}</th>
        <th class="text-end">{{ _('Fee (EUR)') }}</th>
        <th class="text-center">{{ _('Paid') }}</th>
        <th class="text-center">{{ _('Actions') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for r in regs %}
      <tr data-bs-toggle="collapse" data-bs-target="#reg-details-{{ r.id }}" aria-expanded="false" aria-controls="reg-details-{{ r.id }}" style="cursor:pointer;">
        <td>{{ r.id }}</td>
        <td>
          {% if session.get('is_admin') %}
            <a href="{{ url_for('player_detail', player_id=r.player_id) }}">{{ r.player.full_name() }}</a>
          {% else %}
            {{ r.player.full_name() }}
          {% endif %}
        </td>

        <td>
          {% if r.reg_categories %}
            {{ r.reg_categories | map(attribute='category') | select | map(attribute='name') | join(', ') }}
          {% else %}
            <em>â€”</em>
          {% endif %}
        </td>

        <td>
          {% if r.reg_categories %}
            {% set medals = r.reg_categories | map(attribute='medal') | list %}
            {% set any_medals = (medals | select) | list %}
            {% if any_medals %}
              {% for m in medals %}
                {% if m == 'gold' %}<span title="Gold">ðŸ¥‡</span>{% elif m == 'silver' %}<span title="Silver">ðŸ¥ˆ</span>{% elif m == 'bronze' %}<span title="Bronze">ðŸ¥‰</span>{% else %}<span>â€”</span>{% endif %}
              {% endfor %}
            {% else %}
              <em>â€”</em>
            {% endif %}
          {% else %}
            <em>â€”</em>
          {% endif %}
        </td>

        <td class="text-end">
          {% set fee = r.fee_override if r.fee_override is not none else r.computed_fee() %}
          {{ fee if fee is not none else "â€”" }}
        </td>

        <td class="text-center">
          {% if r.paid %}<span class="badge text-bg-success">{{ _('yes') }}</span>{% else %}<span class="badge text-bg-secondary">{{ _('no') }}</span>{% endif %}
        </td>

        <td class="text-center">
          <div class="d-flex justify-content-center flex-wrap gap-2">

            <form method="post" action="{{ url_for('event_reg_delete', reg_id=r.id) }}">
              <button class="btn btn-sm btn-outline-danger">{{ _('Delete') }}</button>
            </form>
          </div>
        </td>
      </tr>
      <tr class="collapse" id="reg-details-{{ r.id }}">
        <td colspan="7">
          {% if r.reg_categories %}
            <form method="post" action="{{ url_for('event_reg_update_medals', reg_id=r.id) }}" class="row g-2 align-items-center">
              <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                  <thead>
                    <tr>
                      <th>{{ _('Category') }}</th>
                      <th>{{ _('Medal') }}</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for rc in r.reg_categories %}
                    <tr>
                      <td>{{ rc.category.name if rc.category else 'â€”' }}</td>
                      <td>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="medal_{{ rc.category_id }}" id="medal_gold_{{ rc.category_id }}_{{ r.id }}" value="gold" {% if rc.medal=='gold' %}checked{% endif %}>
                          <label class="form-check-label text-warning fw-bold" for="medal_gold_{{ rc.category_id }}_{{ r.id }}">&#x1F947; Gold</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="medal_{{ rc.category_id }}" id="medal_silver_{{ rc.category_id }}_{{ r.id }}" value="silver" {% if rc.medal=='silver' %}checked{% endif %}>
                          <label class="form-check-label text-secondary fw-bold" for="medal_silver_{{ rc.category_id }}_{{ r.id }}">&#x1F948; Silver</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="medal_{{ rc.category_id }}" id="medal_bronze_{{ rc.category_id }}_{{ r.id }}" value="bronze" {% if rc.medal=='bronze' %}checked{% endif %}>
                          <label class="form-check-label text-warning" style="color:#cd7f32!important;" for="medal_bronze_{{ rc.category_id }}_{{ r.id }}">&#x1F949; Bronze</label>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="col-12 mt-2">
                <button class="btn btn-sm btn-success">{{ _('Save Medals') }}</button>
              </div>
            </form>
          {% else %}
            <em>{{ _('No categories for this registration.') }}</em>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<hr class="my-4">

<h4>{{ _('Add registrations') }}</h4>
<form method="post" class="row g-3">
  {{ form.hidden_tag() }}
  <div class="col-12 col-md-6">
    <label class="form-label">{{ _('Athlete(s)') }}</label>
    {{ form.player_ids(class_='form-select', multiple=True, size=8, id='player_ids_select') }}
  </div>
  <div class="col-12 col-md-6">
    <label class="form-label">{{ _('Select Categories') }}</label>
    {{ form.category_ids(class_='form-select', multiple=True, size=8) }}

    <div class="mt-3">
      <label class="form-label">{{ _('Fee Override (EUR)') }}</label>
      {{ form.fee_override(class_='form-control', step='1', min='0') }}
    </div>

    <div class="mt-3 form-check">
      {{ form.paid(class_='form-check-input', id='paid_new') }}
      <label class="form-check-label" for="paid_new">{{ _('Paid') }}</label>
    </div>
  </div>

  <div class="col-12">
    <button class="btn btn-primary">{{ _('Add Registration') }}</button>
  </div>
</form>

<script>
// Auto-submit the form on player selection change to update eligible categories
document.addEventListener('DOMContentLoaded', function() {
  var playerSelect = document.getElementById('player_ids_select');
  if (playerSelect) {
    playerSelect.addEventListener('change', function() {
      // Only auto-submit if a single player is selected
      if (playerSelect.selectedOptions.length === 1) {
        // Create a GET form to preserve player selection and reload eligible categories
        var form = document.createElement('form');
        form.method = 'GET';
        form.action = window.location.pathname;
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'player_id';
        input.value = playerSelect.value;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
});
</script>
{% endblock %}