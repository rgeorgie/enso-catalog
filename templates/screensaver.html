<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Screensaver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <style>
    html, body {
      background: black;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: white;
      overflow: hidden;
      position: relative;
    }
    .view {
      display: none;
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
    }
    .view.active {
      display: block;
    }
    .gallery {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }
    .gallery img {
      max-width: 80%;
      max-height: 80%;
      object-fit: contain;
      background: black;
    }
    .calendar {
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .calendar h2 {
      margin-bottom: 20px;
    }
    .event-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      width: 80%;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <!-- Gallery View -->
  <div id="gallery" class="view active">
    <div id="gallery-slideshow"></div>
  </div>

  <!-- Calendar View -->
  <div id="calendar" class="view">
    <div class="calendar">
      <h2>Upcoming Events</h2>
      {% for event in future_events %}
        <div class="event-item">
          <strong>{{ event.title }}</strong><br>
          {{ event.start_date }} - {{ event.location or 'TBD' }}
        </div>
      {% endfor %}
      <h2>Recent Events</h2>
      {% for event in past_events %}
        <div class="event-item">
          <strong>{{ event.title }}</strong><br>
          {{ event.start_date }} - {{ event.location or 'TBD' }}
        </div>
      {% endfor %}
    </div>
  </div>

  <script>
    const views = ['gallery', 'calendar'];
    let currentView = 0;
    const viewDuration = 10000; // 10 seconds per view

    function switchView() {
      document.getElementById(views[currentView]).classList.remove('active');
      currentView = (currentView + 1) % views.length;
      document.getElementById(views[currentView]).classList.add('active');
    }

    setInterval(switchView, viewDuration);

    // Gallery slideshow
    const imageUrls = {{ image_urls | tojson }};
    console.log('imageUrls:', imageUrls);
    let currentImage = 0;
    let imagesShown = 0;
    const galleryDiv = document.getElementById('gallery-slideshow');

    function showNextImage() {
      if (imageUrls.length > 0) {
        galleryDiv.innerHTML = `<img src="${imageUrls[currentImage]}" alt="Gallery Image" onerror="console.error('Failed to load image:', this.src)">`;
        console.log('Showing image:', currentImage, 'of', imageUrls.length);
        imagesShown++;
        currentImage = (currentImage + 1) % imageUrls.length;
        if (imagesShown >= imageUrls.length) {
          // All images shown, switch to next view after 3s
          setTimeout(() => {
            switchView();
            imagesShown = 0;
          }, 3000);
        } else {
          setTimeout(showNextImage, 3000);
        }
      }
    }

    if (imageUrls.length > 0) {
      showNextImage();
    } else {
      console.log('No images available for slideshow');
    }

    // Redirect to kiosk on any activity
    document.addEventListener('click', function() {
      window.location.href = '/kiosk';
    });
    document.addEventListener('touchstart', function() {
      window.location.href = '/kiosk';
    });
    document.addEventListener('keydown', function() {
      window.location.href = '/kiosk';
    });

    // Poll for card scans to exit screensaver
    const pollInterval = setInterval(function() {
      fetch('/card_status')
        .then(response => response.json())
        .then(data => {
          if (data.card_id) {
            clearInterval(pollInterval);
            window.location.href = '/kiosk';
          }
        })
        .catch(error => console.error('Polling error:', error));
    }, 500);  // Poll every 500ms
  </script>
</body>
</html>