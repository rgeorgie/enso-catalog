{% extends "base.html" %}
{% block head %}
  {{ super() }}
{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Card Reader Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div id="card_status" class="mt-2" style="min-height: 2rem;"></div>
        </div>
      </div>

      <!-- Player Grid -->
      <div class="row g-3">
        {% for player in players %}
        <div class="col-lg-3 col-md-4 col-sm-6">
          <div class="card h-100 shadow-sm player-card" data-bs-toggle="modal" data-bs-target="#sessionModal" data-player-id="{{ player.id }}" data-player-name="{{ player.first_name }} {{ player.last_name }}" style="cursor: pointer; transition: transform 0.2s; background-color: rgba(255, 255, 255, 0.5);">
            <div class="card-body text-center p-4">
              {% if player.photo_filename %}
                <img src="{{ url_for('uploaded_file', filename=player.photo_filename) }}" class="rounded-circle mb-3" style="width: 80px; height: 80px; object-fit: cover;" alt="Photo">
              {% else %}
                <div class="rounded-circle mb-3 mx-auto d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background-color: #f8f9fa; border: 2px solid #dee2e6;">
                  <i class="fas fa-user fa-2x text-muted"></i>
                </div>
              {% endif %}

              <h5 class="card-title mb-2">{{ player.first_name }} {{ player.last_name }}</h5>

              <div class="mb-2">
                <span class="badge" style="background-color: {{ belt_colors[player.id] }}; color: #000; font-size: 0.9rem;">
                  {{ player.belt_rank or 'No Belt' }}
                </span>
              </div>

              {% if player.grade_level %}
                <div class="text-muted small mb-3">{{ player.grade_level }}</div>
              {% endif %}

              <div class="mt-3">
                <button class="btn btn-success btn-lg w-100" style="font-size: 1.1rem; padding: 0.75rem;">
                  <i class="fas fa-check-circle me-2"></i>{{ _('Record Session') }}
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if not players %}
        <div class="text-center mt-5">
          <div class="alert alert-info">
            <h4><i class="fas fa-info-circle me-2"></i>{{ _('No players found') }}</h4>
            <p>{{ _('Try adjusting your search criteria.') }}</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Custom backdrop for modal -->
<div id="customBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9997;"></div>

<!-- Session Recording Modal -->
<div class="modal fade" id="sessionModal" tabindex="-1" aria-labelledby="sessionModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="false" style="z-index: 9999;">
  <div class="modal-dialog modal-dialog-centered" style="z-index: 10000;">
    <div class="modal-content" style="z-index: 10001 !important;">
      <div class="modal-header">
        <h5 class="modal-title" id="sessionModalLabel">{{ _('Kiosk Mode - Record Training Session') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('kiosk_record_session') }}">
        <input type="hidden" id="expected_player_id" name="expected_player_id" value="">
        <div class="modal-body">
          <div id="playerInfo" class="mb-3">
            <p class="mb-3">{{ _('Selected athlete:') }} <strong id="selectedPlayerName"></strong></p>
          </div>

          <div class="mb-3">
            <label for="player_id" class="form-label">{{ _('Enter your Player Number') }}</label>
            <input type="text" inputmode="numeric" pattern="[0-9]*" class="form-control form-control-lg" id="player_id" name="player_id" required placeholder="123" style="font-size: 1.2rem; text-align: center;">
            <div class="form-text">{{ _('Enter your player number to confirm and record the session.') }}</div>
          </div>

          <!-- On-screen numeric keypad for touchscreens -->
          <div id="numpad" style="display:none; max-width:420px; margin:0 auto;">
            <div class="d-grid gap-2" style="grid-template-columns: repeat(3,1fr); display:grid;">
              {% for d in range(1,10) %}
                <button type="button" class="btn btn-outline-secondary numpad-key" data-key="{{ d }}" style="font-size:1.4rem; padding:0.85rem;">{{ d }}</button>
              {% endfor %}
              <button type="button" class="btn btn-secondary numpad-key" data-key="back" style="font-size:1.2rem; padding:0.7rem;">âŒ«</button>
              <button type="button" class="btn btn-outline-secondary numpad-key" data-key="0" style="font-size:1.4rem; padding:0.85rem;">0</button>
              <button type="button" class="btn btn-secondary numpad-key" data-key="clear" style="font-size:1.2rem; padding:0.7rem;">C</button>
            </div>
            <div class="mt-2 d-flex justify-content-between">
              <button type="button" id="numpad-close" class="btn btn-light">{{ _('Close') }}</button>
              <button type="button" id="numpad-ok" class="btn btn-success">{{ _('OK') }}</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-success btn-lg">{{ _('Record Session') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.player-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.player-card .card-body {
  min-height: 250px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

@media (max-width: 768px) {
  .display-4 {
    font-size: 2.5rem;
  }

  .player-card .card-body {
    min-height: 200px;
  }

  .btn-lg {
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
}

/* Ensure modal is clickable and not blocked */
.modal-backdrop {
  z-index: 9998 !important;
  background-color: transparent !important;
}
.modal {
  z-index: 9999 !important;
}
.modal-content {
  pointer-events: auto !important;
  z-index: 10001 !important;
  box-shadow: 0 0 20px rgba(0,0,0,0.5) !important;
}
.modal-dialog {
  pointer-events: none;
  z-index: 10000 !important;
}
.modal-dialog .modal-content {
  pointer-events: auto;
  position: relative !important;
}

/* Numpad styles */
#numpad .numpad-key {
  min-height: 56px;
  border-radius: 8px;
}
#numpad .btn-secondary {
  background-color: #f1f3f5;
  border-color: #dee2e6;
}
</style>

<script>
// Handle modal population when player card is clicked
document.addEventListener('DOMContentLoaded', function() {
  const playerCards = document.querySelectorAll('.player-card');
  const selectedPlayerName = document.getElementById('selectedPlayerName');
  const expectedPlayerId = document.getElementById('expected_player_id');
  const customBackdrop = document.getElementById('customBackdrop');
  const cardStatus = document.getElementById('card_status');

  // Card reader functionality via polling
  const pollInterval = setInterval(function() {
    fetch('/card_status')
      .then(response => response.json())
      .then(data => {
        if (data.card_id) {
          processCardScan(data.card_id);
        }
      })
      .catch(error => console.error('Polling error:', error));
  }, 500);  // Poll every 500ms

  function showCardStatus(message, type = 'info') {
    cardStatus.innerHTML = `<div class="alert alert-${type} py-2 mb-0">${message}</div>`;
    setTimeout(() => {
      cardStatus.innerHTML = '';
    }, 5000);
  }

  function processCardScan(cardId) {
    // Send AJAX request to record session
    fetch('{{ url_for("kiosk_record_session_card") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'card_id': cardId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showCardStatus(`<strong>${data.player_name}</strong> (${data.belt_rank})<br>${data.message}`, 'success');
        // Play success sound if available
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(`Welcome ${data.player_name.split(' ')[0]}! Session recorded.`);
          speechSynthesis.speak(utterance);
        }
      } else {
        showCardStatus(data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showCardStatus('{{ _("Error processing card scan. Please try again.") }}', 'danger');
    });
  }

  // Focus card reader input on page load
  // cardReaderInput.focus();

  playerCards.forEach(card => {
    card.addEventListener('click', function() {
      const playerName = this.dataset.playerName;
      const playerId = this.dataset.playerId;
      selectedPlayerName.textContent = playerName;
      expectedPlayerId.value = playerId;
      
      // Show custom backdrop
      if (customBackdrop) {
        customBackdrop.style.display = 'block';
      }
    });
  });

  // Clear form when modal is hidden
  const sessionModal = document.getElementById('sessionModal');
  sessionModal.addEventListener('hidden.bs.modal', function() {
    document.getElementById('player_id').value = '';
    expectedPlayerId.value = '';
    
    // Hide custom backdrop
    if (customBackdrop) {
      customBackdrop.style.display = 'none';
    }
  });

  // Auto-focus on Player Number input when modal is shown
  sessionModal.addEventListener('shown.bs.modal', function() {
    document.getElementById('player_id').focus();
    // Show on-screen numpad when modal opens
    const numpad = document.getElementById('numpad');
    if (numpad) {
      numpad.style.display = 'block';
    }
  });

  // Inactivity timer for kiosk mode - return to kiosk after 5 minutes of inactivity
  let inactivityTimer;
  const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(function() {
      // Go to screensaver after inactivity
      window.location.href = '/screensaver';
    }, INACTIVITY_TIMEOUT);
  }

  function setupActivityListeners() {
    // List of events to track for activity
    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'touchmove', 'click'];
    
    events.forEach(function(event) {
      document.addEventListener(event, resetInactivityTimer, true);
    });
  }

  // Start the inactivity timer
  setupActivityListeners();
  resetInactivityTimer();

  // Numpad logic
  (function() {
    const numpad = document.getElementById('numpad');
    const input = document.getElementById('player_id');
    const okBtn = document.getElementById('numpad-ok');
    const closeBtn = document.getElementById('numpad-close');
    if (!numpad || !input) return;

    function insertChar(ch) {
      const start = input.selectionStart || input.value.length;
      const end = input.selectionEnd || start;
      input.value = input.value.slice(0, start) + ch + input.value.slice(end);
      const pos = start + ch.length;
      input.setSelectionRange(pos, pos);
      input.focus();
    }

    function backspace() {
      const start = input.selectionStart || input.value.length;
      const end = input.selectionEnd || start;
      if (start === end && start > 0) {
        input.value = input.value.slice(0, start-1) + input.value.slice(end);
        const pos = start-1;
        input.setSelectionRange(pos, pos);
      } else if (start !== end) {
        input.value = input.value.slice(0, start) + input.value.slice(end);
        input.setSelectionRange(start, start);
      }
      input.focus();
    }

    function clearInput() {
      input.value = '';
      input.focus();
    }

    document.querySelectorAll('.numpad-key').forEach(btn => {
      btn.addEventListener('click', function(e) {
        const k = this.dataset.key;
        if (!k) return;
        if (k === 'back') backspace();
        else if (k === 'clear') clearInput();
        else insertChar(k);
      });
    });

    if (okBtn) okBtn.addEventListener('click', function() {
      const form = okBtn.closest('.modal-content').querySelector('form');
      if (form) form.submit();
    });

    if (closeBtn) closeBtn.addEventListener('click', function() {
      numpad.style.display = 'none';
      const modal = bootstrap.Modal.getInstance(document.getElementById('sessionModal'));
      if (modal) modal.hide();
    });
  })();
});
</script>

{% endblock %}