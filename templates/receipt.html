{% extends "base.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}?v=20260129">
{% endblock %}

{% block content %}
<div class="receipt card p-4">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h3 class="mb-1">Payment Receipt</h3>
      <div class="text-muted"># {{ rec.receipt_no or '—' }}</div>
      <div class="text-muted">Date: {{ (rec.paid_at or rec.created_at).strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
    <div class="text-end">
      <div><strong>Player:</strong> {{ player.full_name() }}</div>
      <div><strong>ID:</strong> {{ player.id }}</div>
    </div>
  </div>

  <hr/>

  {% if rec.kind.startswith('training') %}
    <p><strong>Category:</strong> Training fee</p>
    {% if rec.kind == 'training_month' %}
      <p><strong>Plan:</strong> Per month &nbsp;|&nbsp;
         <strong>Month:</strong> {{ "%04d-%02d"|format(rec.year or 0, rec.month or 0) }}</p>
    {% else %}
      <p><strong>Plan:</strong> Per session</p>
      <p><strong>Sessions:</strong> {{ rec.sessions_taken }}/{{ rec.sessions_paid }} taken</p>
      <form method="post" action="{{ url_for('receipt_tick_session', rid=rec.id) }}" class="no-print">
        <button class="btn btn-sm btn-outline-primary">Mark one session taken</button>
      </form>
    {% endif %}
  {% else %}
    <p><strong>Category:</strong> Event</p>
    {% if ev %}
      <p><strong>Event:</strong> {{ ev.title }}
        ({{ ev.start_date }}{% if ev.end_date %} – {{ ev.end_date }}{% endif %})
      </p>
    {% endif %}
  {% endif %}

  {% if rec.note and 'AUTO_DEBT' in rec.note %}
    <hr>
    <div class="no-print">
      <form method="post" action="{{ url_for('receipt_pay_debt', rid=rec.id) }}">
        <div class="mb-2 form-text">This receipt was auto-generated as a debt for extra sessions.</div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-success" type="submit">Record payment for this debt</button>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('payment_new', player_id=rec.player_id, amount=rec.amount) }}">Open payment form</a>
        </div>
      </form>
    </div>
  {% endif %}

  <p class="mt-3">
    <strong>Amount:</strong> {{ rec.amount }} {{ rec.currency }}
    {% if rec.method %}&nbsp;|&nbsp;<strong>Method:</strong> {{ rec.method }}{% endif %}
  </p>

  {% if rec.note %}
    <p><strong>Notes:</strong> {{ rec.note }}</p>
  {% endif %}

  <!-- Stamp: small and bottom-right (size comes from print.css; inline is a safety cap) -->
  <div class="stamp">
    <img src="{{ url_for('static', filename='img/enso-logo.webp') }}"
         alt="ENSO Stamp" style="max-width: 3.2cm; max-height: 3.2cm;">
  </div>

  <div class="mt-3 no-print d-flex gap-2">
    <button class="btn btn-primary" type="button" onclick="window.print()">Print</button>
    <a class="btn btn-outline-secondary" href="{{ request.referrer or url_for('list_players') }}">Back</a>
  </div>

</div>

<script>
  // Auto-open print dialog when the page loads (give the CSS a moment to apply)
  window.addEventListener('load', () => setTimeout(() => window.print(), 250));
</script>
{% endblock %}