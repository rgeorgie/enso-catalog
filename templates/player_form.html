{% extends "base.html" %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}?v=20260131">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
{% endblock %}
{% block content %}
<h1 class="mb-4">{{ title }}</h1>

<form method="post" enctype="multipart/form-data">
  {{ form.csrf_token }}
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">{{ _('First Name') }}</label>
      {{ form.first_name(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Last Name') }}</label>
      {{ form.last_name(class="form-control") }}
    </div>

    <div class="col-md-4">
      <label class="form-label">{{ _('Gender') }}</label>
      {{ form.gender(class="form-select") }}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Birthdate') }}</label>
      {{ form.birthdate(class="form-control", type="date") }}
    </div>
    {% if session.get('is_admin') %}
    <div class="col-md-4">
      <label class="form-label">{{ _('PN#') }}</label>
      {{ form.pn(class="form-control") }}
    </div>
    {% else %}
      {{ form.pn(type="hidden") }}
    {% endif %}

    <!-- Grade (select only) -->
    <div class="col-md-4">
      <label class="form-label">{{ _('Grade') }}</label>
      {{ form.grade_level(class_="form-select", id="grade_level") }}
      <div class="form-text mt-1">
        <span id="belt_preview" class="belt-chip" style="border:1px solid #ced4da;">&nbsp;</span>
      </div>
    </div>
    
    <div class="col-md-4">
      <label class="form-label">{{ _('Grade Date') }}</label>
      {{ form.grade_date(class="form-control", type="date") }}
    </div>

    <div class="col-md-4">
      <label class="form-label">{{ _('Discipline') }}</label>
      {{ form.discipline(class="form-select") }}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Weight (kg)') }}</label>
      {{ form.weight_kg(class="form-control") }}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Height (cm)') }}</label>
      {{ form.height_cm(class="form-control") }}
    </div>

    <div class="col-md-6">
      <label class="form-label">{{ _('Email') }}</label>
      {{ form.email(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Phone') }}</label>
      {{ form.phone(class="form-control") }}
    </div>

    <div class="col-md-6">
      <label class="form-label">{{ _('Card ID') }}</label>
      <div class="input-group">
        {{ form.card_id(class="form-control", id="card_id_input") }}
        <button class="btn btn-outline-secondary" type="button" id="read_card_btn">{{ _('Read Card') }}</button>
      </div>
    </div>

    <!-- Parents -->
    <div class="col-12 mt-3"><h5>{{ _('Mother Name') }} / {{ _('Father Name') }}</h5></div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Mother Name') }}</label>
      {{ form.mother_name(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Mother Phone') }}</label>
      {{ form.mother_phone(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Father Name') }}</label>
      {{ form.father_name(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('Father Phone') }}</label>
      {{ form.father_phone(class="form-control") }}
    </div>

    <div class="col-md-4">
      <label class="form-label">{{ _('Join Date') }}</label>
      {{ form.join_date(class="form-control", type="date") }}
    </div>
    <div class="col-md-4 d-flex align-items-center">
      <div class="form-check mt-4">
        {{ form.active_member(class="form-check-input") }}
        <label class="form-check-label">{{ _('Active Member') }}</label>
      </div>
    </div>

    <!-- Medical / Insurance -->
    <div class="col-12 mt-3"><h5>{{ _('Medical Examination') }}</h5></div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Examination Date') }}</label>
      {{ form.medical_exam_date(class="form-control", type="date") }}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Expiry Date') }}</label>
      {{ form.medical_expiry_date(class="form-control", type="date") }}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Insurance Expiry Date') }}</label>
      {{ form.insurance_expiry_date(class="form-control", type="date") }}
    </div>

    <!-- Training Fee -->
    <div class="col-12 mt-3"><h5>{{ _('Monthly Fee Type') }}</h5></div>
    <div class="col-md-4">
      <label class="form-label">{{ _('Training Fee (EUR)') }}</label>
      {{ form.monthly_fee_amount(class="form-control", placeholder="50") }}
    </div>
    <div class="col-md-4 d-flex align-items-center">
      <div class="form-check form-switch mt-4">
        {{ form.monthly_fee_is_monthly(class="form-check-input", id="monthly_switch", role="switch") }}
        <label class="form-check-label" for="monthly_switch"><span id="monthly_label">{{ _('Month') if (form.monthly_fee_is_monthly.data) else _('Session') }}</span></label>
      </div>
    </div>

    <div class="col-12">
      <label class="form-label">{{ _('Notes') }}</label>
      {{ form.notes(class="form-control", rows="4") }}
    </div>

    <div class="col-md-6">
      <label class="form-label">{{ _('Photo (jpg/png/gif/webp, â‰¤ 2MB)') }}</label>
      <input class="form-control" type="file" name="photo" accept=".png,.jpg,.jpeg,.gif,.webp">
    </div>

    <!-- Sportdata -->
    <div class="col-12 mt-3"><h5>{{ _('Sportdata Profiles') }}</h5></div>
    <div class="col-md-6">
      <label class="form-label">{{ _('WKF Profile URL') }}</label>
      {{ form.sportdata_wkf_url(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('BNFK Profile URL') }}</label>
      {{ form.sportdata_bnfk_url(class="form-control") }}
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ _('ENSO Profile URL') }}</label>
      {{ form.sportdata_enso_url(class="form-control") }}
    </div>


    <div class="col-12">
        <button class="btn btn-primary" type="submit">{{ _('Save') }}</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">{{ _('Cancel') }}</a>
        <a class="btn btn-secondary mt-2" href="{{ request.referrer or url_for('list_players') }}">{{ _('Back') }}</a>
      </div>

      <!-- Inline prepay (only when editing an existing player) -->
      
      {% if player %}
      <div class="col-12 mt-4" id="prepay_card" style="display: {% if player.monthly_fee_is_monthly %}none{% else %}block{% endif %};">
        <div class="card p-3">
          <div class="card-header"><strong>Pre-pay training sessions</strong></div>
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label class="form-label">Sessions</label>
                <input id="prepay_sessions" type="number" class="form-control" min="1" value="8">
              </div>
              <div class="col-auto">
                <label class="form-label">Amount (EUR)</label>
                <input id="prepay_amount" type="number" class="form-control" step="1" min="0" value="{% if (not player.monthly_fee_is_monthly and player.monthly_fee_amount) %}{{ player.monthly_fee_amount }}{% else %}0{% endif %}">
              </div>
              <div class="col-auto">
                <label class="form-label">&nbsp;</label>
                <button id="prepay_btn" type="button" class="btn btn-success">Pre-pay</button>
              </div>
              <div class="col-12">
                <div id="prepay_msg" class="form-text text-success" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</form>

{% if session.get('is_admin') %}
<div class="mt-3">
  <h5>{{ _('Import Players from CSV') }}</h5>
  <form method="post" action="{{ url_for('admin_players_import_csv') }}" enctype="multipart/form-data" class="row g-2">
    <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
    <div class="col-auto">
      <input class="form-control" type="file" name="csv_file" accept=".csv" required>
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">{{ _('Import CSV') }}</button>
    </div>
    <div class="col-12 form-text">{{ _('CSV should include headers: first_name,last_name,email,phone,gender,birthdate,join_date,pn (required),grade_level,monthly_fee_amount') }}</div>
  </form>
</div>
{% endif %}
{% if player and session.get('is_admin') %}
<div class="mt-3">
  <form method="post" action="{{ url_for('delete_player', player_id=player.id) }}" onsubmit="return confirm('Delete this player and all related records?');" class="d-inline">
    <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
    <button class="btn btn-danger">Delete Player</button>
  </form>
</div>
{% endif %}

<script>
  // Show/hide prepay card based on monthly/session switch
  document.addEventListener('DOMContentLoaded', function() {
    var monthlySwitch = document.getElementById('monthly_switch');
    var prepayCard = document.getElementById('prepay_card');
    if (monthlySwitch && prepayCard) {
      function updatePrepayCard() {
        prepayCard.style.display = monthlySwitch.checked ? 'none' : 'block';
      }
      monthlySwitch.addEventListener('change', updatePrepayCard);
      updatePrepayCard();
    }
  });
  const BELT_COLORS = {{ belt_colors_json|safe }};
  function idealTextColor(hex) {
    const c = hex.replace('#','');
    const r = parseInt(c.substring(0,2), 16);
    const g = parseInt(c.substring(2,4), 16);
    const b = parseInt(c.substring(4,6), 16);
    const yiq = (r*299 + g*587 + b*114) / 1000;
    return yiq >= 128 ? '#000000' : '#ffffff';
  }
  function updateBeltPreview() {
    const sel = document.getElementById('belt_rank');
    const chip = document.getElementById('belt_preview');
    if (!sel || !chip) return;
    const color = BELT_COLORS[sel.value] || '#6c757d';
    chip.style.background = color;
    chip.style.color = idealTextColor(color);
    chip.textContent = sel.value || '';
  }
  const GRADE_TO_COLOR = {{ grade_to_color_json|safe }};
  function updateBeltPreview() {
    const sel = document.getElementById('grade_level');
    const chip = document.getElementById('belt_preview');
    if (!sel || !chip) return;
    const grade = sel.value || '';
    const belt = GRADE_TO_COLOR[grade] || '';
    const color = BELT_COLORS[belt] || '#6c757d';
    chip.style.background = color;
    chip.style.color = idealTextColor(color);
    chip.textContent = grade || '';
  }
  document.getElementById('grade_level')?.addEventListener('change', updateBeltPreview);
  updateBeltPreview();
  // Toggle label for training fee switch
  const ms = document.getElementById('monthly_switch');
  if (ms) {
    ms.addEventListener('change', function() {
      const lbl = document.getElementById('monthly_label');
      if (!lbl) return;
      lbl.textContent = this.checked ? '{{ _('Month') }}' : '{{ _('Session') }}';
    });
  }

  // Inline prepay POST
  const prepayBtn = document.getElementById('prepay_btn');
  if (prepayBtn) {
    prepayBtn.addEventListener('click', async () => {
      const sessions = parseInt(document.getElementById('prepay_sessions').value || '0', 10);
      const amount = parseInt(document.getElementById('prepay_amount').value || '0', 10);
      const msg = document.getElementById('prepay_msg');
      if (!sessions || sessions <= 0) {
        msg.style.display = 'block'; msg.textContent = 'Please enter sessions >= 1'; return;
      }
      const fd = new URLSearchParams();
      fd.append('kind', 'training_session');
      fd.append('player_id', '{{ player.id if player else "" }}');
      fd.append('sessions_paid', String(sessions));
      fd.append('amount', String(amount));
      fd.append('currency', 'EUR');

      try {
        const resp = await fetch('{{ url_for('payment_new') }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: fd.toString(),
          credentials: 'same-origin'
        });
        if (resp.redirected) {
          // go to receipt page
          window.location.href = resp.url;
          return;
        }
        const text = await resp.text();
        msg.style.display = 'block'; msg.textContent = 'Prepayment recorded.';
      } catch (e) {
        msg.style.display = 'block'; msg.textContent = 'Prepayment failed.';
      }
    });
  }
</script>

<script>
  // Card reader functionality
  document.addEventListener('DOMContentLoaded', function() {
    const readCardBtn = document.getElementById('read_card_btn');
    const cardIdInput = document.getElementById('card_id_input');

    if (readCardBtn && cardIdInput) {
      // Card reader functionality via SocketIO
      const socket = io();

      socket.on('card_scan', function(data) {
        cardIdInput.value = data.card_id;
        readCardBtn.textContent = '{{ _("Read Card") }}';
        readCardBtn.disabled = false;
      });

      readCardBtn.addEventListener('click', function() {
        cardIdInput.focus();
        cardIdInput.value = '';
        readCardBtn.textContent = '{{ _("Reading...") }}';
        readCardBtn.disabled = true;

        // Timeout after 10 seconds
        setTimeout(() => {
          readCardBtn.textContent = '{{ _("Read Card") }}';
          readCardBtn.disabled = false;
        }, 10000);
      });
    }
  });
</script>

{% endblock %}