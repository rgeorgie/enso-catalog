{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">{{ ev.title }}</h1>
  <div class="d-flex gap-2">
    {% if ev.sportdata_url %}
      <a class="btn btn-outline-primary btn-sm" href="{{ ev.sportdata_url }}" target="_blank" rel="noopener">Sportdata</a>
    {% endif %}
    {% if session.get('is_admin') %}
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_export_csv', event_id=ev.id) }}">{{ _('Export Registrations CSV') }}</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_export_full', event_id=ev.id) }}">{{ _('Export Event (full ZIP)') }}</a>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('event_payment_report', event_id=ev.id) }}" target="_blank">{{ _('Payment Report') }}</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_edit', event_id=ev.id) }}">{{ _('Edit Event') }}</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_categories', event_id=ev.id) }}">{{ _('Categories') }}</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('event_registrations', event_id=ev.id) }}">{{ _('Registrations') }}</a>
      <form method="post" action="{{ url_for('event_delete', event_id=ev.id) }}" class="d-inline">
        <button class="btn btn-outline-danger btn-sm" type="submit">{{ _('Delete') }}</button>
      </form>
    {% endif %}
    <a class="btn btn-secondary btn-sm ms-2" href="{{ request.referrer or url_for('event_list') }}">{{ _('Back') }}</a>
  </div>
</div>

<p class="text-muted">
  <strong>{{ _('Start Date') }}:</strong> {{ ev.start_date }}
  &nbsp;|&nbsp;
  <strong>{{ _('End Date') }}:</strong> {{ ev.end_date or ev.start_date }}
  {% if ev.location %}&nbsp;|&nbsp;<strong>{{ _('Location') }}:</strong> {{ ev.location }}{% endif %}
</p>

{% if ev.notes %}
  <div class="mb-4">
    <h5>{{ _('Notes') }}</h5>
    <p>{{ ev.notes }}</p>
  </div>
{% endif %}

<!-- Totals summary -->
<div class="row g-3 mb-4">
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Participants') }}</div>
        <div class="fs-4 fw-semibold">{{ unique_participants }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Entries') }}</div>
        <div class="fs-4 fw-semibold">{{ entries_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Total expected') }}</div>
        <div class="fs-4 fw-semibold">{{ total_expected }} â‚¬</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Total paid') }}</div>
        <div class="fs-4 fw-semibold text-success">{{ total_paid }} â‚¬</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Total unpaid') }}</div>
        <div class="fs-4 fw-semibold text-danger">{{ total_unpaid }} â‚¬</div>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">{{ _('Medals') }}</div>
        <div>
          <span class="badge text-bg-warning text-dark">ðŸ¥‡ {{ medal_gold }}</span>
          <span class="badge text-bg-secondary ms-1">ðŸ¥ˆ {{ medal_silver }}</span>
          <span class="badge text-bg-bronze ms-1" style="background:#cd7f32;color:#fff;">ðŸ¥‰ {{ medal_bronze }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<h4 class="mt-3">{{ _('Registrations') }}</h4>
{% if player_summaries %}
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Entries') }}</th>
          <th>{{ _('Categories') }} / {{ _('Medals') }}</th>
          <th class="text-end">{{ _('Amount') }}</th>
          <th class="text-center">{{ _('Paid') }}</th>
        </tr>
      </thead>
      <tbody>
      {% for ps in player_summaries %}
        <tr>
          <td>
            {% if session.get('is_admin') %}
              <a href="{{ url_for('player_detail', player_id=ps.player.id) }}">{{ ps.player.full_name() }}</a>
            {% else %}
              {{ ps.player.full_name() }}
            {% endif %}
          </td>
          <td>{{ ps.entries }}</td>
          <td>
            {% set all_categories = [] %}
            {% for r in ps.regs %}
              {% for rc in r.reg_categories %}
                {% set _ = all_categories.append(rc) %}
              {% endfor %}
            {% endfor %}
            {% if all_categories %}
              <div class="d-flex flex-wrap gap-2">
                {% for rc in all_categories %}
                  <span class="badge text-bg-secondary">
                    {{ rc.category.name }}
                    {% if rc.medal == 'gold' %} Â· ðŸ¥‡ {{ _('Gold') }}
                    {% elif rc.medal == 'silver' %} Â· ðŸ¥ˆ {{ _('Silver') }}
                    {% elif rc.medal == 'bronze' %} Â· ðŸ¥‰ {{ _('Bronze') }}
                    {% endif %}
                  </span>
                {% endfor %}
              </div>
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="text-end">
            {% if ps.total_expected > 0 %}
              {{ ps.total_expected }} â‚¬
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="text-center">
            {% if ps.total_expected > 0 %}
              {% if ps.total_paid == ps.total_expected %}
                <span class="badge bg-success">{{ _('Yes') }}</span>
              {% elif ps.total_paid > 0 %}
                <span class="badge bg-warning">{{ ps.total_paid }} / {{ ps.total_expected }} â‚¬</span>
              {% else %}
                <span class="badge bg-danger">{{ _('No') }}</span>
              {% endif %}
            {% else %}
              â€”
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-muted">{{ _('No registrations yet.') }}</div>
{% endif %}
{% if session.get('is_admin') %}
  {# import modal intentionally removed from detail view; available on New Event form #}
{% endif %}
{% endblock %}