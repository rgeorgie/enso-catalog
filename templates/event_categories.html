<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importModalLabel">{{ _('Paste/Import Categories') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="importTextarea" class="form-label">{{ _('Paste tabular data (one row per category, columns: Name, Age from, Age to, Sex, Fee, Team size, KYU, DAN, Other cut-off date, Limit, Team Limit)') }}</label>
          <textarea id="importTextarea" class="form-control" rows="8" placeholder="Category\t10\t12\tM\t50\t3\t8\t1\t2024-05-01\t20\t5"></textarea>
        </div>
        <div id="importPreview" class="mb-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="importSubmitBtn">{{ _('Import') }}</button>
      </div>
    </div>
  </div>
</div>

<script>
// Parse pasted data and preview
function parseCategoryRows(text) {
  const lines = text.trim().split(/\r?\n/);
  return lines.map(line => line.split(/\t|\s{2,}/));
}

function renderPreview(rows) {
  if (!rows.length) return '';
  let html = '<table class="table table-bordered table-sm"><thead><tr>' +
    ['Name','Age from','Age to','Sex','Fee','Team size','KYU','DAN','Other cut-off date','Limit','Team Limit']
      .map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  for (const row of rows) {
    html += '<tr>' + row.map(cell => `<td>${cell||''}</td>`).join('') + '</tr>';
  }
  html += '</tbody></table>';
  return html;
}

document.addEventListener('DOMContentLoaded', function() {
  const ta = document.getElementById('importTextarea');
  const preview = document.getElementById('importPreview');
  ta.addEventListener('input', function() {
    const rows = parseCategoryRows(ta.value);
    preview.innerHTML = renderPreview(rows);
  });

  document.getElementById('importSubmitBtn').addEventListener('click', function() {
    const rows = parseCategoryRows(ta.value);
    if (!rows.length) return;
    // Always use the correct event_id for the import endpoint
    const eventId = {{ ev.id }};
    fetch(`/admin/events/${eventId}/categories/import`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ form.csrf_token._value() }}' },
      body: JSON.stringify({ rows })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Import failed');
      }
    })
    .catch(()=>alert('Import failed'));
  });
});
</script>
{% extends "base.html" %}
{% block content %}
<h1 class="mb-3">{{ _('Categories') }} — {{ ev.title }}</h1>


<form method="post" class="row g-3 mb-4">
  {{ form.csrf_token }}
  <div class="col-md-3">
    <label class="form-label">{{ _('Category Name') }}</label>
    <input name="name" class="form-control" required>
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Age from') }}</label>
    <input name="age_from" type="number" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Age to') }}</label>
    <input name="age_to" type="number" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Sex') }}</label>
    <input name="sex" class="form-control" placeholder="M/F">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Category Fee') }}</label>
    <input name="fee" type="number" class="form-control" placeholder="EUR">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Team size') }}</label>
    <input name="team_size" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('KYU') }}</label>
    <input name="kyu" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('DAN') }}</label>
    <input name="dan" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Other cut-off date') }}</label>
    <input name="other_cutoff_date" class="form-control" placeholder="YYYY-MM-DD">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Limit') }}</label>
    <input name="limit" class="form-control">
  </div>
  <div class="col-md-1">
    <label class="form-label">{{ _('Team Limit') }}</label>
    <input name="limit_team" class="form-control">
  </div>
  <div class="col-md-2 d-flex align-items-end gap-2">
    <button class="btn btn-primary w-100" type="submit">{{ _('Add Category') }}</button>
    <a class="btn btn-secondary w-100" href="{{ url_for('event_detail', event_id=ev.id) }}">{{ _('Back') }}</a>
  </div>
</form>


{% if cats %}
  <div class="table-responsive">
    <table class="table table-striped align-middle table-sm">
      <thead>
        <tr>
          <th>#</th>
          <th>{{ _('Category Name') }}</th>
          <th>{{ _('Age from') }}</th>
          <th>{{ _('Age to') }}</th>
          <th>{{ _('Sex') }}</th>
          <th>{{ _('Category Fee') }}</th>
          <th>{{ _('Team size') }}</th>
          <th>{{ _('KYU') }}</th>
          <th>{{ _('DAN') }}</th>
          <th>{{ _('Other cut-off date') }}</th>
          <th>{{ _('Limit') }}</th>
          <th>{{ _('Team Limit') }}</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      {% for c in cats %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ c.name }}</td>
          <td>{{ c.age_from or '—' }}</td>
          <td>{{ c.age_to or '—' }}</td>
          <td>{{ c.sex or '—' }}</td>
          <td>{{ c.fee if c.fee is not none else '—' }}</td>
          <td>{{ c.team_size or '—' }}</td>
          <td>{{ c.kyu or '—' }}</td>
          <td>{{ c.dan or '—' }}</td>
          <td>{{ c.other_cutoff_date or '—' }}</td>
          <td>{{ c.limit or '—' }}</td>
          <td>{{ c.limit_team or '—' }}</td>
          <td class="text-end">
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-sm btn-outline-secondary edit-category-btn" data-cat-id="{{ c.id }}">{{ _('Edit') }}</button>
              <form method="post" action="{{ url_for('event_category_delete', event_id=ev.id, cat_id=c.id) }}" onsubmit="return confirm('{{ _('Delete Category') }}?');" class="m-0">
                <button class="btn btn-sm btn-outline-danger" type="submit">{{ _('Delete') }}</button>
              </form>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="text-muted">{{ _('No categories yet.') }}</div>
{% endif %}

<div class="mt-3 d-flex gap-2">
  <a class="btn btn-outline-secondary" href="{{ url_for('event_detail', event_id=ev.id) }}">{{ _('Event') }}</a>
  <a class="btn btn-outline-secondary" href="{{ url_for('event_registrations', event_id=ev.id) }}">{{ _('Registrations') }}</a>
  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal">{{ _('Paste/Import Categories') }}</button>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="editCategoryModalContent">
      <!-- content loaded dynamically -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalEl = document.getElementById('editCategoryModal');
  const modalContent = document.getElementById('editCategoryModalContent');

  document.querySelectorAll('.edit-category-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
      const catId = this.dataset.catId;
      const url = '/admin/events/{{ ev.id }}/categories/' + catId + '/edit';
      // fetch the edit form fragment
      try {
        const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const html = await resp.text();
        modalContent.innerHTML = html;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // handle save button
        const saveBtn = modalContent.querySelector('#categorySaveBtn');
        const form = modalContent.querySelector('#categoryEditForm');
        saveBtn.addEventListener('click', async () => {
          const formData = new FormData(form);
            const postResp = await fetch(url, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              body: formData
            });
            // Try parse JSON error/success
            const json = await postResp.json().catch(() => null);
            if (json) {
              if (json.success) {
                modal.hide();
                location.reload();
              } else {
                // show returned error inside modal
                let errDiv = modalContent.querySelector('.modal-error');
                if (!errDiv) {
                  errDiv = document.createElement('div');
                  errDiv.className = 'alert alert-danger modal-error';
                  const formEl = modalContent.querySelector('#categoryEditForm');
                  formEl.parentNode.insertBefore(errDiv, formEl);
                }
                errDiv.textContent = json.error || (json.errors && json.errors.join('\n')) || 'Save failed';
              }
            } else {
              // fallback: replace modal content with returned HTML
              const text = await postResp.text();
              modalContent.innerHTML = text;
            }
        });
      } catch (e) {
        alert('Failed to load edit form');
      }
    });
  });
});
</script>

<!-- Import Modal (to be implemented in next step) -->
<!-- Modal markup and JS will be added in the next step -->
{% endblock %}