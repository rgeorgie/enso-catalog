{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">{{ _('Players') }}</h1>
  <div class="d-flex gap-2 align-items-center flex-wrap">
    {% if session.get('is_admin') %}
      <a class="btn btn-primary" href="{{ url_for('create_player') }}">{{ _('+ Add Player') }}</a>
    {% endif %}
    <a class="btn btn-outline-success" href="{{ url_for('export_csv') }}">{{ _('Export CSV') }}</a>
    <a class="btn btn-outline-success" href="{{ url_for('export_players_zip') }}">⬇️ {{ _('Export All Profiles (ZIP)') }}</a>
    {% if session.get('is_admin') %}
      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#playersImportModal">⬆️ {{ _('Import Players (ZIP)') }}</button>
    {% endif %}
    <a class="btn btn-secondary" href="{{ request.referrer or url_for('events_calendar') }}">{{ _('Back') }}</a>
  </div>
</div>

<form class="row g-3 mb-4" method="get">
  <div class="col-12 col-md-6 col-lg-4">
    <label class="form-label">{{ _('Search') }}</label>
    <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="{{ _('Name') }}">
  </div>
  <div class="col-6 col-md-3 col-lg-2">
    <label class="form-label">{{ _('Grade') }}</label>
    <select class="form-select" name="belt">
      <option value="">{{ _('All') }}</option>
      {% for value in belts %}
        <option value="{{ value }}" {% if belt==value %}selected{% endif %}>{{ _(value) }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-3 col-lg-2">
    <label class="form-label">{{ _('Active') }}</label>
    <select class="form-select" name="active">
      <option value="">{{ _('All') }}</option>
      <option value="yes" {% if active=="yes" %}selected{% endif %}>{{ _('Active') }}</option>
      <option value="no" {% if active=="no" %}selected{% endif %}>{{ _('Inactive') }}</option>
    </select>
  </div>
  <div class="col-12 col-md-12 col-lg-4 d-flex align-items-end gap-2">
    <button class="btn btn-primary" type="submit">{{ _('Apply') }}</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('list_players') }}">{{ _('Reset') }}</a>
  </div>
</form>

<div class="table-responsive">
  {% if session.get('is_admin') %}
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Grade') }}</th>
          <th>{{ _('Discipline') }}</th>
          <th>{{ _('Monthly Fee Type') }}</th>
          <th>{{ _('Monthly Due') }}</th>
          <th>{{ _('Active') }}</th>
          <!-- <th>{{ _('Email') }}</th> -->
          <th>{{ _('Sportdata') }}</th>
          <th>{{ _('Health') }}</th>
          <th style="width: 160px;"></th>
        </tr>
      </thead>
      <tbody>
      {% for p in players %}
        <tr>
          <td><a href="{{ url_for('player_detail', player_id=p.id) }}">{{ p.full_name() }}</a></td>
          <td><span class="belt-chip" style="{{ belt_chip_style(p.belt_rank) }}">{{ p.grade_level or _(p.belt_rank) }}</span></td>
          <td>{{ _(p.discipline) }}</td>
          <td>
            {% if p.monthly_fee_amount is not none %}
              {{ p.monthly_fee_amount }} EUR ({{ _('monthly') if p.monthly_fee_is_monthly else _('per session') }})
              {% if not p.monthly_fee_is_monthly %}
                <div class="small text-muted">Paid: {{ p.total_sessions_paid }} • Taken: {{ p.total_sessions_taken }} • Owed: {{ p.owed_amount if p.owed_amount is not none else '—' }} EUR</div>
                  {% if p.has_debt %}
                    <div class="small mt-1">
                      {% if p.debt_total_recorded and p.debt_total_recorded > 0 %}
                        {% if p.debt_total_expected and p.debt_total_expected > 0 %}
                          {% set remaining = (p.debt_total_expected - p.debt_total_recorded) %}
                          {% if remaining > 0 %}
                            <span class="badge bg-danger">Recorded debt: {{ p.debt_total_recorded }} EUR</span>
                            <span class="small text-danger ms-2">Remaining owed: {{ remaining }} EUR</span>
                          {% elif remaining < 0 %}
                            <span class="badge bg-success">Recorded debt: {{ p.debt_total_recorded }} EUR</span>
                            <span class="small text-success ms-2">Overpaid: {{ -remaining }} EUR</span>
                          {% else %}
                            <span class="badge bg-success">Recorded debt: {{ p.debt_total_recorded }} EUR</span>
                            <span class="small text-success ms-2">Fully recorded</span>
                          {% endif %}
                        {% else %}
                          <span class="badge bg-success">Recorded debt: {{ p.debt_total_recorded }} EUR</span>
                        {% endif %}
                      {% else %}
                        {% if p.debt_total_expected and p.debt_total_expected > 0 %}
                          <span class="badge bg-danger">Owed (not recorded): {{ p.debt_total_expected }} EUR</span>
                        {% endif %}
                      {% endif %}
                    </div>
                  {% endif %}
              {% endif %}
              {% if p.payment_count == 0 %}
                <div class="small mt-1"><span class="badge text-bg-warning text-dark">No payments</span></div>
              {% endif %}
            {% else %}—{% endif %}
          </td>
          <td>
            {% if p.monthly_due_amount is not none %}
              {% if p.monthly_due_paid %}
                <span class="text-success">{{ p.monthly_due_amount }} EUR</span>
              {% else %}
                <span class="text-danger">{{ p.monthly_due_amount }} EUR</span>
              {% endif %}
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if p.active_member %}
              <span class="badge bg-success">{{ _('Yes') }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ _('No') }}</span>
            {% endif %}
          </td>
          <!--
          <td>
            {% if p.email %}
              <a href="mailto:{{ p.email }}">{{ p.email }}</a>
            {% else %}—{% endif %}
          </td>
          -->
          <td class="text-nowrap">
            {% if p.sportdata_wkf_url %}<a class="btn btn-sm btn-outline-primary me-1" target="_blank" href="{{ p.sportdata_wkf_url }}">WKF</a>{% endif %}
            {% if p.sportdata_bnfk_url %}<a class="btn btn-sm btn-outline-primary me-1" target="_blank" href="{{ p.sportdata_bnfk_url }}">BNFK</a>{% endif %}
            {% if p.sportdata_enso_url %}<a class="btn btn-sm btn-outline-primary" target="_blank" href="{{ p.sportdata_enso_url }}">ENSO</a>{% endif %}
          </td>
          <td class="text-nowrap">
            <span class="badge bg-{{ p.med_color }} me-1">Med: {{ p.med_text }}</span>
            <span class="badge bg-{{ p.ins_color }}">Ins: {{ p.ins_text }}</span>
          </td>
          <td>
            <div class="d-flex flex-row justify-content-end gap-2">
              <form class="m-0" method="post" action="{{ url_for('record_session', player_id=p.id) }}">
                <button class="btn btn-sm btn-outline-secondary" type="submit">{{ _('Record Session') }}</button>
              </form>
              <button class="btn btn-sm {% if p.has_debt %}btn-danger{% else %}btn-outline-success{% endif %} pay-due-modal-btn ms-auto" type="button" data-player-id="{{ p.id }}">{{ _('Pay Due') }}</button>
            </div>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="10" class="text-center text-muted">{{ _('No players found.') }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>{{ _('Name') }}</th>
          <th>{{ _('Grade') }}</th>
          <th>{{ _('Active') }}</th>
        </tr>
      </thead>
      <tbody>
      {% for p in players %}
        <tr>
          <td>{{ p.full_name() }}</td>
          <td><span class="belt-chip" style="{{ belt_chip_style(p.belt_rank) }}">{{ p.grade_level or _(p.belt_rank) }}</span></td>
          <td>
            {% if p.active_member %}
              <span class="badge bg-success">{{ _('Yes') }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ _('No') }}</span>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="3" class="text-center text-muted">{{ _('No players found.') }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<!-- PAY DUE MODAL -->
<div class="modal fade" id="payDueModal" tabindex="-1" aria-labelledby="payDueModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="payDueForm">
        <div class="modal-header">
          <h5 class="modal-title" id="payDueModalLabel">Outstanding Dues</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="duesList">
            <div class="text-center text-muted py-3">Loading...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Confirm Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let currentPayDuePlayerId = null;
document.addEventListener('DOMContentLoaded', function() {
  // Open modal and fetch dues for selected player
  document.querySelectorAll('.pay-due-modal-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      currentPayDuePlayerId = this.getAttribute('data-player-id');
      const payDueModalEl = document.getElementById('payDueModal');
      try { if (payDueModalEl && payDueModalEl.parentNode !== document.body) document.body.appendChild(payDueModalEl); } catch(e){}
      const payDueModal = new bootstrap.Modal(payDueModalEl);
      document.getElementById('duesList').innerHTML = '<div class="text-center text-muted py-3">Loading...</div>';
      payDueModal.show();
      fetch(`/admin/players/${currentPayDuePlayerId}/dues_json`)
        .then(response => response.json())
        .then(data => {
          const duesData = data.dues || [];
          const duesList = document.getElementById('duesList');
          if (!duesData.length) {
            duesList.innerHTML = '<div class="text-center text-muted py-3">Nothing to show.</div>';
            return;
          }
          duesList.innerHTML = duesData.map(function(due, idx) {
            if (due.type === 'owed_sessions' && due.session_list) {
              return `<div class="mb-2">
                <div class="fw-bold mb-1">
                  ${due.label} <span class="badge bg-info text-dark ms-2">${due.amount} EUR</span>
                </div>
                <div class="ms-4 mt-2" id="sessions_${idx}">
                  ${due.session_list.map((sess, sidx) => `
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="${sess.session_id}" id="session_${sess.session_id}" name="session_ids_${idx}" checked>
                      <label class="form-check-label" for="session_${sess.session_id}">
                        ${sess.date} <span class="badge bg-secondary ms-2">${sess.session_id}</span>
                      </label>
                    </div>
                  `).join('')}
                </div>
              </div>`;
            } else {
              return `<div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="${due.id}" id="due_${due.id}" name="dues">
                <label class="form-check-label" for="due_${due.id}">
                  ${due.label} <span class="badge bg-info text-dark ms-2">${due.amount} EUR</span>
                </label>
              </div>`;
            }
          }).join('');
        });
    });
  });

  // Handle payment submission
  document.getElementById('payDueForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!currentPayDuePlayerId) return;
    var checked = Array.from(document.querySelectorAll('#duesList input[name="dues"]:checked')).map(cb => cb.value);
    var duesToSend = [];
    // Only send checked owed sessions
    var checkedSessionCheckboxes = Array.from(document.querySelectorAll('input[name^="session_ids_"]:checked'));
    var sessionIds = checkedSessionCheckboxes.map(cb => cb.value);
    if (sessionIds.length > 0) {
      duesToSend.push({type: 'owed_sessions', session_ids: sessionIds});
    }
    // Handle all other dues
    checked.forEach(function(val) {
      duesToSend.push(val);
    });
    if (duesToSend.length === 0) return;
    fetch(`/admin/players/${currentPayDuePlayerId}/pay_due_receipt`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dues: duesToSend })
    })
    .then(response => response.json())
    .then(data => {
      if (data.redirect) {
        window.location.href = data.redirect;
      }
    });
  });
});
</script>

{% if session.get('is_admin') %}
<!-- Players import modal -->
<div class="modal fade" id="playersImportModal" tabindex="-1" aria-labelledby="playersImportModalLabel" aria-hidden="true" data-bs-backdrop="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="importPlayersZipForm" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="playersImportModalLabel">{{ _('Import Players (ZIP)') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">Upload ZIP produced by "Export All Profiles (ZIP)". Photos are ignored.</p>
          <div class="mb-3">
            <input class="form-control" type="file" name="zipfile" accept=".zip" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="button" id="importPlayersZipBtn" class="btn btn-primary">{{ _('Import') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">{{ _('Loading...') }}</span>
        </div>
        <p class="mt-2">{{ _('Processing import... Please wait.') }}</p>
      </div>
    </div>
  </div>
</div>

<script>
function showLoadingModal(event) {
  // This function is not used anymore, but kept for compatibility
  return true;
}

// Handle import button with AJAX
document.addEventListener('DOMContentLoaded', function() {
  console.log('Script loaded for players_list');
  const importBtn = document.getElementById('importPlayersZipBtn');
  if (importBtn) {
    importBtn.addEventListener('click', function() {
      console.log('Import button clicked (players_list)');
      const form = document.getElementById('importPlayersZipForm');
      const fileInput = form.querySelector('input[type="file"]');
      if (!fileInput || !fileInput.files[0]) {
        console.log('No file selected');
        alert('{{ _("Please select a file first.") }}');
        return;
      }
      console.log('File selected:', fileInput.files[0].name);

      // Hide the import modal
      const importModal = bootstrap.Modal.getInstance(document.getElementById('playersImportModal'));
      if (importModal) {
        importModal.hide();
        console.log('Import modal hidden');
      } else {
        console.log('Import modal instance not found, force hiding');
        const modalEl = document.getElementById('playersImportModal');
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.setAttribute('aria-hidden', 'true');
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        console.log('Import modal force hidden');
      }

      // Show loading modal
      const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), { backdrop: 'static', keyboard: false });
      loadingModal.show();
      console.log('Loading modal shown');

      // Prepare form data
      const formData = new FormData(form);
      console.log('FormData prepared');

      // Send AJAX request
      console.log('Sending fetch to:', '{{ url_for("import_players_zip") }}');
      fetch('{{ url_for("import_players_zip") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Response received:', response.status, response.statusText);
        return response.text();
      })
      .then(html => {
        console.log('Response text received, reloading page');
        // Reload page to show flash messages
        window.location.reload();
      })
      .catch(error => {
        console.error('Import error:', error);
        loadingModal.hide();
        alert('{{ _("Import failed. Please try again.") }}');
      });
    });
  } else {
    console.log('Import button not found (players_list)');
  }
});
</script>

{% endblock %}